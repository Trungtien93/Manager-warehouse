@model MNBEMART.Models.StockTransfer
@using MNBEMART.Models
@{
    ViewData["Title"] = "Chi tiết phiếu chuyển kho";
    decimal totalQty = Model.Details?.Sum(d => d.Quantity) ?? 0m;
    string FQty(decimal v) => (v % 1m == 0m) ? ((long)v).ToString() : v.ToString("0.##");
}

<!-- Tailwind + Bootstrap Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

<div class="max-w-[1400px] mx-auto px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight mb-2">
                    <i class="bi bi-arrow-left-right text-blue-600 me-2"></i>
                    Phiếu chuyển kho: @Model.TransferNumber
                </h1>
                <p class="text-slate-600">
                    Tạo lúc @Model.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm") • Người lập: @Model.CreatedBy?.FullName
                </p>
            </div>
            <div class="flex items-center gap-3">
                @if (Model.Status == DocumentStatus.Moi)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-amber-100 text-amber-800">Mới</span>
                }
                else if (Model.Status == DocumentStatus.DaXacNhan)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800">Đã xác nhận</span>
                }
                else if (Model.Status == DocumentStatus.HoanThanh)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-800">Hoàn thành</span>
                }
                else if (Model.Status == DocumentStatus.DaHuy)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800">Đã huỷ</span>
                }
                <a asp-action="PrintOne" asp-route-id="@Model.Id" target="_blank" 
                   class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2.5 rounded-lg transition flex items-center gap-2">
                    <i class="bi bi-printer"></i> In phiếu
                </a>
                <a asp-action="Index" class="bg-slate-600 hover:bg-slate-700 text-white font-medium px-5 py-2.5 rounded-lg transition flex items-center gap-2">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Transfer Info -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Thông tin phiếu</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-semibold text-slate-600">Kho đi</label>
                        <p class="text-slate-900 font-semibold">@Model.FromWarehouse?.Name</p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-600">Kho đến</label>
                        <p class="text-slate-900 font-semibold">@Model.ToWarehouse?.Name</p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-600">Ghi chú</label>
                        <p class="text-slate-900">@(string.IsNullOrWhiteSpace(Model.Note) ? "-" : Model.Note)</p>
                    </div>
                    
                    @if (Model.ApprovedAt.HasValue)
                    {
                        <div class="border-t border-slate-200 pt-4">
                            <div class="text-sm">
                                <p class="font-semibold text-slate-900 mb-1">Đã duyệt</p>
                                <p class="text-slate-600">Bởi: @Model.ApprovedBy?.FullName</p>
                                <p class="text-slate-600">Lúc: @Model.ApprovedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                        </div>
                    }
                    
                    @if (User.IsInRole("Admin"))
                    {
                        <div class="border-t border-slate-200 pt-4 space-y-2">
                            @if (Model.Status == DocumentStatus.Moi)
                            {
                                <form asp-action="Approve" method="post" onsubmit="return confirm('Duyệt phiếu này?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                                        <i class="bi bi-check-circle"></i> Duyệt phiếu
                                    </button>
                                </form>
                                <form asp-action="Cancel" method="post" onsubmit="return confirm('Huỷ phiếu này?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <button class="w-full bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                                        <i class="bi bi-x-circle"></i> Huỷ phiếu
                                    </button>
                                </form>
                            }
                            else if (Model.Status == DocumentStatus.DaXacNhan)
                            {
                                <form asp-action="Complete" method="post" onsubmit="return confirm('Hoàn thành chuyển kho?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <button class="w-full bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                                        <i class="bi bi-check2-circle"></i> Hoàn thành
                                    </button>
                                </form>
                                <form asp-action="Cancel" method="post" onsubmit="return confirm('Huỷ phiếu này?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <button class="w-full bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                                        <i class="bi bi-x-circle"></i> Huỷ phiếu
                                    </button>
                                </form>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column: Material Details -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Danh sách vật tư</h3>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800">
                        @Model.Details.Count mặt hàng
                    </span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:35%">Mã / Tên vật tư</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:12%">NSX</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:12%">HSD</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-slate-700 uppercase" style="width:12%">Số lượng</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:8%">ĐVT</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:21%">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            @foreach (var d in Model.Details ?? Enumerable.Empty<StockTransferDetail>())
                            {
                                <tr class="hover:bg-slate-50">
                                    <td class="px-4 py-3">
                                        <div class="text-sm font-semibold text-slate-900">@d.Material?.Code</div>
                                        <div class="text-xs text-slate-500">@d.Material?.Name</div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-slate-600">
                                        @((d.ManufactureDate ?? d.Material?.ManufactureDate)?.ToString("dd/MM/yyyy") ?? "-")
                                    </td>
                                    <td class="px-4 py-3 text-sm text-slate-600">
                                        @((d.ExpiryDate ?? d.Material?.ExpiryDate)?.ToString("dd/MM/yyyy") ?? "-")
                                    </td>
                                    <td class="px-4 py-3 text-right text-sm font-semibold text-slate-900">
                                        @FQty(d.Quantity)
                                    </td>
                                    <td class="px-4 py-3 text-sm text-slate-700">
                                        @d.Unit
                                    </td>
                                    <td class="px-4 py-3 text-sm text-slate-600">
                                        @(string.IsNullOrWhiteSpace(d.Note) ? "-" : d.Note)
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-right text-sm font-bold text-slate-900" colspan="3">Tổng cộng:</th>
                                <th class="px-4 py-3 text-right text-sm font-bold text-slate-900">@FQty(totalQty)</th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
