@* @model MNBEMART.Models.StockAdjustment
@{
    ViewData["Title"] = "Tạo phiếu điều chỉnh tồn";
    var materials = ViewBag.Materials as List<MNBEMART.Models.Material>;
}
<h3>@ViewData["Title"]</h3>

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Kho</label>
            <select asp-for="WarehouseId" class="form-select" asp-items="ViewBag.WarehouseId"></select>
            <span asp-validation-for="WarehouseId" class="text-danger"></span>
        </div>
        <div class="col-md-6">
            <label class="form-label">Lý do điều chỉnh</label>
            <input asp-for="Reason" class="form-control" />
        </div>
    </div>

    <h5 class="mt-4">Chi tiết (nhập số âm để giảm, số dương để tăng)</h5>
    <table class="table table-bordered align-middle" id="detailTable">
        <thead class="table-light">
            <tr>
                <th style="width:50%">Vật tư</th>
                <th style="width:30%">Số lượng chênh lệch (+/-)</th>
                <th style="width:20%"></th>
            </tr>
        </thead>
        <tbody>
            <!-- dòng mẫu sẽ clone bằng JS -->
        </tbody>
    </table>

    <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddRow">+ Thêm dòng</button>

    <div class="mt-4">
        <button class="btn btn-primary">Lưu</button>
        <a asp-action="Index" class="btn btn-secondary">Huỷ</a>
    </div>
</form>

@section Scripts {
<script>
(function() {
    const materials = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        (materials ?? new List<MNBEMART.Models.Material>()).Select(m => new { m.Id, m.Name })
    ));

    const tbody = document.querySelector('#detailTable tbody');
    const btnAdd = document.getElementById('btnAddRow');

    function addRow(data) {
        const idx = tbody.children.length;
        const tr = document.createElement('tr');

        tr.innerHTML = `
            <td>
                <select name="Details[${idx}].MaterialId" class="form-select">
                    <option value="">-- Chọn vật tư --</option>
                    ${materials.map(m => `<option value="${m.Id}">${m.Name}</option>`).join('')}
                </select>
            </td>
            <td>
                <input name="Details[${idx}].QuantityDiff" type="number" step="0.001" class="form-control" value="${data?.QuantityDiff ?? ''}"/>
            </td>
            <td class="text-end">
                <button type="button" class="btn btn-outline-danger btn-sm btnRemove">Xoá</button>
            </td>
        `;

        tbody.appendChild(tr);
        tr.querySelector('.btnRemove')?.addEventListener('click', () => { tr.remove(); reindex(); });
    }

    function reindex() {
        [...tbody.children].forEach((tr, i) => {
            tr.querySelectorAll('input,select,textarea').forEach(el => {
                el.name = el.name.replace(/Details\[\d+\]/, `Details[${i}]`);
            });
        });
    }

    btnAdd.addEventListener('click', () => addRow());
    addRow(); // 1 dòng đầu
})();
</script>
} *@

@model MNBEMART.Models.StockAdjustment
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.AspNetCore.Mvc.ViewFeatures
@{
    ViewData["Title"] = "Tạo phiếu điều chỉnh tồn";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

@{
    // Build SelectList vật tư có "Mã - Tên"
    var mats = (IEnumerable<MNBEMART.Models.Material>)ViewBag.Materials;
    var matOptions = mats.Select(m => new SelectListItem {
        Value = m.Id.ToString(), Text = $"{m.Code} - {m.Name}"
    }).ToList();
    ViewData["MaterialOptions"] = matOptions;

    // Bảo đảm có ít nhất 1 dòng để hiển thị
    var rowCount = (Model?.Details?.Count ?? 0);
    if (rowCount == 0) { Model.Details.Add(new MNBEMART.Models.StockAdjustmentDetail()); rowCount = 1; }
}

<div class="container-fluid py-3">
  <h3 class="mb-3">Tạo phiếu điều chỉnh tồn</h3>

  <form asp-action="Create" method="post" id="form-create">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Kho</label>
        @Html.DropDownList("WarehouseId", (SelectList)ViewBag.WarehouseId, "-- Chọn kho --", new { @class = "form-select", id = "warehouseId" })
      </div>
      <div class="col-md-3">
        <label class="form-label">Ngày lập</label>
        <input asp-for="CreatedAt" type="datetime-local" class="form-control" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Lý do</label>
        <input asp-for="Reason" class="form-control" />
      </div>
    </div>

    <div class="card mt-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Chi tiết điều chỉnh</h5>
          <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-row">+ Thêm dòng</button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle mb-0" id="tbl-details">
            <thead class="table-light text-center">
              <tr>
                <th style="width:36%">Vật tư</th>
                <th style="width:12%">ĐVT</th>
                <th style="width:16%">Tồn (theo kho)</th>
                <th style="width:16%" class="text-end">Chênh lệch (±)</th>
                <th>Ghi chú</th>
                <th style="width:40px"></th>
              </tr>
            </thead>
            <tbody>
              @for (int i = 0; i < rowCount; i++)
              {
                  var vdd = new ViewDataDictionary(ViewData);
                  vdd.TemplateInfo.HtmlFieldPrefix = $"Details[{i}]";
                  @await Html.PartialAsync("_DetailRow", Model.Details.ElementAt(i), vdd)
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Lưu phiếu</button>
      <a class="btn btn-outline-secondary" asp-action="Index">Hủy</a>
    </div>
  </form>
</div>

@section Scripts {
  <partial name="_ValidationScriptsPartial" />
  <script src="~/js/stockadjustment.create.js"></script>
}
