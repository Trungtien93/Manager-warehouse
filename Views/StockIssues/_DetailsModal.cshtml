@model MNBEMART.Models.StockIssue
@using MNBEMART.Models

@{
    decimal sumQty = Model.Details?.Sum(d => Convert.ToDecimal(d.Quantity)) ?? 0m;
    decimal sumAmt = Model.Details?.Sum(d => Convert.ToDecimal(d.Quantity) * d.UnitPrice) ?? 0m;
    decimal sumCOGS = Model.Details?.Sum(d => Convert.ToDecimal(d.Quantity) * (d.CostPrice ?? d.UnitPrice)) ?? 0m;
    decimal grossProfit = sumAmt - sumCOGS;

    var lotAllocations = ViewBag.LotAllocations as List<StockIssueAllocation> ?? new List<StockIssueAllocation>();
    
    string StatusBadge(DocumentStatus s) => s switch {
        DocumentStatus.Moi         => "badge bg-secondary",
        DocumentStatus.DaXacNhan   => "badge bg-warning text-dark",
        DocumentStatus.DaXuatHang  => "badge bg-success",
        DocumentStatus.DaHuy       => "badge bg-danger",
        _                          => "badge bg-light text-dark"
    };
}

<div class="modal fade" id="issueDetailsModal-@Model.Id" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-md-down modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-1">
            Phiếu xuất: <span class="fw-semibold">@Model.IssueNumber</span>
          </h5>
          <div class="small text-muted">
            Tạo lúc @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm") • Người lập: @Model.CreatedBy?.FullName
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="@StatusBadge(Model.Status)">@Model.Status</span>
        </div>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="border rounded p-3 bg-light">
              <div class="mb-2">
                <div class="text-muted small">Kho</div>
                <div class="fw-semibold">@Model.Warehouse?.Name</div>
              </div>
              <div class="mb-2">
                <div class="text-muted small">Người nhận</div>
                <div>@(string.IsNullOrWhiteSpace(Model.ReceivedByName) ? "-" : Model.ReceivedByName)</div>
              </div>
              <div class="mb-2">
                <div class="text-muted small">Ghi chú</div>
                <div>@(string.IsNullOrWhiteSpace(Model.Note) ? "-" : Model.Note)</div>
              </div>

              @if (Model.ApprovedAt.HasValue)
              {
                <hr />
                <div class="small">
                  Đã xác nhận bởi <strong>@Model.ApprovedBy?.FullName</strong> lúc @Model.ApprovedAt?.ToString("dd/MM/yyyy HH:mm")
                </div>
              }
            </div>
          </div>

          <div class="col-lg-8">
            <!-- Document Management Section -->
            <div class="mb-3">
              @await Html.PartialAsync("_DocumentManagement", new { DocumentType = "StockIssue", DocumentId = Model.Id } as object)
            </div>
            
            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width:25%">Mã / Tên vật tư</th>
                    <th>Quy cách</th>
                    <th style="width:8%">ĐVT</th>
                    <th style="width:10%" class="text-end">Số lượng</th>
                    <th style="width:12%" class="text-end">Giá bán</th>
                    <th style="width:12%" class="text-end">Giá vốn</th>
                    <th style="width:12%" class="text-end">Thành tiền</th>
                    <th style="width:11%" class="text-end">Lợi nhuận</th>
                  </tr>
                </thead>
                <tbody>
                @foreach (var d in Model.Details ?? Enumerable.Empty<MNBEMART.Models.StockIssueDetail>())
                {
                    var q = Convert.ToDecimal(d.Quantity);
                    var costPrice = d.CostPrice ?? d.UnitPrice;
                    var line = q * d.UnitPrice;
                    var lineCOGS = q * costPrice;
                    var lineProfit = line - lineCOGS;
                    var detailLots = lotAllocations.Where(a => a.StockIssueDetailId == d.Id).ToList();
                    var totalAllocated = detailLots.Sum(a => a.Quantity);
                    
                    <tr>
                      <td>
                        <div class="fw-semibold">@d.Material?.Code</div>
                        <div class="text-muted small text-truncate">@d.Material?.Name</div>
                      </td>
                      <td>@(string.IsNullOrWhiteSpace(d.Specification) ? "-" : d.Specification)</td>
                      <td>@(string.IsNullOrWhiteSpace(d.Unit) ? d.Material?.Unit : d.Unit)</td>
                      <td class="text-end">@q.ToString("0.##")</td>
                      <td class="text-end">@d.UnitPrice.ToString("n0")</td>
                      <td class="text-end text-info">@costPrice.ToString("n0")</td>
                      <td class="text-end">@line.ToString("n0")</td>
                      <td class="text-end @(lineProfit >= 0 ? "text-success" : "text-danger")">@lineProfit.ToString("n0")</td>
                    </tr>
                    @if (detailLots.Any())
                    {
                        <tr>
                            <td colspan="8" class="bg-light p-0">
                                <details class="m-2">
                                    <summary class="cursor-pointer user-select-none p-2 bg-white border rounded d-flex align-items-center gap-2">
                                        <i class="bi bi-box-seam text-info"></i>
                                        <span class="fw-semibold">Chi tiết phân bổ lô</span>
                                        <span class="badge bg-info">@detailLots.Count lô</span>
                                        <span class="ms-auto text-muted small">Click để xem</span>
                                    </summary>
                                    <div class="mt-2">
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:30%">Số lô</th>
                                                    <th style="width:20%">NSX</th>
                                                    <th style="width:30%">HSD</th>
                                                    <th style="width:20%" class="text-end">SL xuất</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var alloc in detailLots)
                                                {
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-secondary">@(alloc.StockLot?.LotNumber ?? "N/A")</span>
                                                        </td>
                                                        <td>@(alloc.StockLot?.ManufactureDate?.ToString("dd/MM/yyyy") ?? "-")</td>
                                                        <td>
                                                            @if (alloc.StockLot?.ExpiryDate.HasValue == true)
                                                            {
                                                                var daysLeft = (alloc.StockLot.ExpiryDate.Value - DateTime.Today).Days;
                                                                <span>@alloc.StockLot.ExpiryDate.Value.ToString("dd/MM/yyyy")</span>
                                                                @if (daysLeft < 0)
                                                                {
                                                                    <span class="badge bg-danger ms-1"><i class="bi bi-exclamation-triangle"></i> Hết hạn</span>
                                                                }
                                                                else if (daysLeft <= 30)
                                                                {
                                                                    <span class="badge bg-warning text-dark ms-1"><i class="bi bi-clock"></i> Còn @daysLeft ngày</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-success ms-1"><i class="bi bi-check-circle"></i> Còn @daysLeft ngày</span>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <text>-</text>
                                                            }
                                                        </td>
                                                        <td class="text-end">
                                                            <span class="badge bg-primary fs-6">@alloc.Quantity.ToString("0.##")</span>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                            <tfoot class="table-secondary">
                                                <tr>
                                                    <td colspan="3" class="text-end fw-bold">Tổng đã xuất:</td>
                                                    <td class="text-end">
                                                        <span class="badge bg-success fs-6">@totalAllocated.ToString("0.##")</span>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </details>
                            </td>
                        </tr>
                    }
                }
                </tbody>
                <tfoot>
                  <tr class="table-light">
                    <th colspan="3" class="text-end">Tổng</th>
                    <th class="text-end">@sumQty.ToString("0.##")</th>
                    <th></th>
                    <th class="text-end text-info">@sumCOGS.ToString("n0")</th>
                    <th class="text-end fw-semibold">@sumAmt.ToString("n0")</th>
                    <th class="text-end fw-semibold @(grossProfit >= 0 ? "text-success" : "text-danger")">@grossProfit.ToString("n0")</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        @if (User.IsInRole("admin"))
        {
            <div class="me-auto d-flex gap-2">
              @* Trạng thái Mới -> nút Xác nhận *@
              @if (Model.Status == DocumentStatus.Moi)
              {
                <form asp-action="Approve" method="post" class="d-inline">
                  @Html.AntiForgeryToken()
                  <input type="hidden" name="id" value="@Model.Id" />
                  <button class="btn btn-warning">Xác nhận</button>
                </form>
              }
              @* Trạng thái Đã xác nhận -> nút Chọn lô & Xuất hàng *@
              @if (Model.Status == DocumentStatus.DaXacNhan)
              {
                <button class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#lotSelectionModal-@Model.Id">
                  <i class="bi bi-box-seam"></i> Chọn lô & Xuất hàng
                </button>
              }
              @* Chưa huỷ -> cho phép huỷ *@
              @if (Model.Status != DocumentStatus.DaHuy)
              {
                <form asp-action="Reject" method="post" class="d-inline" onsubmit="return confirmReject(this);">
                  @Html.AntiForgeryToken()
                  <input type="hidden" name="id" value="@Model.Id" />
                  <input type="hidden" name="note" value="" />
                  <button class="btn btn-outline-danger">Huỷ phiếu</button>
                </form>
              }
            </div>
        }
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
        <a class="btn btn-outline-primary" asp-action="PrintOne" asp-route-id="@Model.Id">In phiếu</a>
      </div>
    </div>
  </div>
</div>

<!-- Include modal chọn lô (chỉ khi phiếu đang ở trạng thái Đã xác nhận) -->
@if (Model.Status == DocumentStatus.DaXacNhan)
{
    @await Html.PartialAsync("_IssueLotSelectionModal", Model)
}

<style>
  /* Cho phép cuộn trang phía sau modal phiếu xuất */
  body.modal-open.allow-scroll {
    overflow: auto !important;
    padding-right: 0 !important;
  }
</style>

<script>
  function confirmReject(form){
    const reason = prompt("Lý do huỷ phiếu:", "");
    if (reason === null) return false;
    form.querySelector('input[name="note"]').value = reason || "";
    return true;
  }

  // Cho phép cuộn trang phía sau modal (giống như modal phiếu nhập)
  (function() {
    const modal = document.getElementById('issueDetailsModal-@Model.Id');
    if (!modal) return;

    modal.addEventListener('shown.bs.modal', function() {
      // Thêm class để cho phép scroll
      document.body.classList.add('allow-scroll');
      // Đảm bảo body có thể scroll
      document.body.style.overflow = 'auto';
      document.body.style.paddingRight = '0';
    });

    modal.addEventListener('hidden.bs.modal', function() {
      // Xóa class khi modal đóng
      document.body.classList.remove('allow-scroll');
      // Khôi phục lại style mặc định nếu cần
      const otherModals = document.querySelectorAll('.modal.show');
      if (otherModals.length === 0) {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
    });
  })();

  // Không cần JavaScript toggle nữa - dùng HTML5 <details> tag
</script>
