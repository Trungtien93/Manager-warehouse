@model MNBEMART.Models.StockIssue
@using MNBEMART.Models

@{
    decimal sumQty = Model.Details?.Sum(d => Convert.ToDecimal(d.Quantity)) ?? 0m;
}

<div class="modal fade" id="lotSelectionModal-@Model.Id" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-md-down modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <div>
          <h5 class="modal-title mb-1">
            <i class="bi bi-box-seam"></i> Chọn lô xuất hàng
          </h5>
          <div class="small opacity-75">
            Phiếu: <span class="fw-semibold">@Model.IssueNumber</span>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>

      <form id="lotSelectionForm-@Model.Id" asp-action="IssuePost" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />

        <div class="modal-body">
          <div class="alert alert-info d-flex align-items-start gap-2">
            <i class="bi bi-info-circle flex-shrink-0 mt-1"></i>
            <div class="small">
              <strong>Hướng dẫn:</strong> Chọn lô xuất cho từng vật tư. Hệ thống tự động gợi ý theo nguyên tắc FEFO (First Expired First Out - lô sắp hết hạn xuất trước).
              Bạn có thể điều chỉnh số lượng xuất từng lô hoặc để mặc định.
            </div>
          </div>

          <div id="lotAccordion-@Model.Id">
            @{int idx = 0;}
            @foreach (var d in Model.Details ?? Enumerable.Empty<MNBEMART.Models.StockIssueDetail>())
            {
                var q = Convert.ToDecimal(d.Quantity);
                idx++;
                <div class="card mb-3 border">
                  <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <span class="badge bg-secondary me-2">@idx</span>
                        <strong>@d.Material?.Code</strong> - @d.Material?.Name
                      </div>
                      <div class="text-end">
                        <span class="text-muted small">Cần xuất:</span>
                        <span class="fw-bold text-primary">@q.ToString("0.##")</span> @d.Unit
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="mb-3 d-flex gap-2">
                      <button type="button" class="btn btn-sm btn-outline-primary load-lots-btn"
                              data-detail-id="@d.Id"
                              data-material-id="@d.MaterialId"
                              data-warehouse-id="@Model.WarehouseId"
                              data-required-qty="@q">
                        <i class="bi bi-arrow-clockwise"></i> Tải danh sách lô
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-success auto-allocate-btn"
                              data-detail-id="@d.Id"
                              data-required-qty="@q"
                              disabled>
                        <i class="bi bi-magic"></i> Tự động phân bổ FEFO
                      </button>
                    </div>
                      
                      <!-- Container chứa danh sách lô -->
                      <div class="lots-container" data-detail-id="@d.Id">
                        <div class="text-muted text-center py-4">
                          <div class="mb-3">
                            <i class="bi bi-box fs-1 text-secondary"></i>
                          </div>
                          <div class="fw-semibold mb-2">Danh sách lô chưa được tải</div>
                          <div class="small text-muted">
                            Nhấn nút <strong>"Tải danh sách lô"</strong> ở trên để xem các lô có thể xuất
                          </div>
                        </div>
                      </div>

                    <!-- Tổng kết -->
                    <div class="mt-3 p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-6">
                          <small class="text-muted">Yêu cầu:</small>
                          <div class="fw-bold">@q.ToString("0.##") @d.Unit</div>
                        </div>
                        <div class="col-6 text-end">
                          <small class="text-muted">Đã phân bổ:</small>
                          <div class="fw-bold text-success allocated-qty" data-detail-id="@d.Id">0</div>
                        </div>
                      </div>
                      <div class="mt-2 allocated-status" data-detail-id="@d.Id">
                        <small class="text-danger">⚠️ Chưa phân bổ đủ</small>
                      </div>
                    </div>
                  </div>
                </div>
            }
          </div>
        </div>

        <div class="modal-footer">
          <div class="me-auto">
            <div id="globalError-@Model.Id" class="text-danger small"></div>
          </div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-success" id="confirmIssueBtn-@Model.Id" disabled>
            <i class="bi bi-check-circle"></i> Xác nhận xuất hàng
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  #lotSelectionModal-@Model.Id .modal-body {
    max-height: calc(100vh - 200px) !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
  }
  .lot-row {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s;
  }
  .lot-row:hover {
    background-color: #f8f9fa;
    border-color: #0d6efd;
  }
  .lot-row input[type="number"] {
    max-width: 120px;
  }
  .lot-expired {
    border-left: 3px solid #dc3545;
  }
  .lot-expiring-soon {
    border-left: 3px solid #ffc107;
  }
  .lots-container {
    height: 400px !important;
    max-height: 400px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    display: block !important;
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
  }
  .lots-container .table-responsive {
    display: block !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    max-height: 100% !important;
    height: 100% !important;
  }
  .lots-container .table {
    margin-bottom: 0;
    width: 100%;
  }
  .lots-container .table thead {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
  }
</style>

<script>
(function(){
  const modalId = 'lotSelectionModal-@Model.Id';
  const modal = document.getElementById(modalId);
  if(!modal) return;

  const getLotsUrl = '@Url.Action("GetAvailableLots", "StockIssues")';
  let lotsData = {}; // key: detailId -> array of lots

  // Load lots cho 1 chi tiết
  modal.addEventListener('click', async (e) => {
    const btn = e.target.closest('.load-lots-btn');
    if(!btn) return;
    
    const detailId = btn.dataset.detailId;
    const materialId = btn.dataset.materialId;
    const warehouseId = btn.dataset.warehouseId;
    const requiredQty = parseFloat(btn.dataset.requiredQty);

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang tải...';

    try {
      const url = `${getLotsUrl}?warehouseId=${warehouseId}&materialId=${materialId}`;
      const res = await fetch(url);
      const data = await res.json();

      if(!data.success) {
        alert(data.message || 'Lỗi tải danh sách lô');
        return;
      }

      lotsData[detailId] = data.lots;
      renderLots(detailId, data.lots, requiredQty);
      btn.innerHTML = '<i class="bi bi-check"></i> Đã tải';
      btn.classList.remove('btn-outline-primary');
      btn.classList.add('btn-success');
      
      // Enable nút auto-allocate
      const autoBtn = modal.querySelector(`.auto-allocate-btn[data-detail-id="${detailId}"]`);
      if(autoBtn) autoBtn.disabled = false;
    } catch(err) {
      alert('Lỗi kết nối: ' + err.message);
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Tải danh sách lô';
    }
  });

  // Render danh sách lô
  function renderLots(detailId, lots, requiredQty) {
    const container = modal.querySelector(`.lots-container[data-detail-id="${detailId}"]`);
    if(!container) return;

    if(!lots || lots.length === 0) {
      container.innerHTML = '<div class="alert alert-warning">Không có lô nào khả dụng</div>';
      return;
    }

    const today = new Date();
    let html = '<div class="table-responsive"><table class="table table-sm table-bordered align-middle mb-0"><thead class="table-light"><tr><th>Số lô</th><th>NSX</th><th>HSD</th><th class="text-end">Tồn kho</th><th style="width:140px">Xuất</th></tr></thead><tbody>';

    lots.forEach((lot, i) => {
      const expDate = lot.expDate ? new Date(lot.expDate) : null;
      let rowClass = '';
      let expStatus = '';
      if(expDate) {
        const daysDiff = Math.floor((expDate - today) / (1000*60*60*24));
        if(daysDiff < 0) {
          rowClass = 'lot-expired';
          expStatus = '<small class="badge bg-danger">Hết hạn</small>';
        } else if(daysDiff <= 30) {
          rowClass = 'lot-expiring-soon';
          expStatus = '<small class="badge bg-warning text-dark">Sắp hết hạn</small>';
        }
      }

      html += `<tr class="${rowClass}">
        <td>
          <div class="fw-semibold">${lot.lotNumber}</div>
          ${expStatus}
        </td>
        <td>${lot.mfgDate ? new Date(lot.mfgDate).toLocaleDateString('vi-VN') : '-'}</td>
        <td>${lot.expDate ? new Date(lot.expDate).toLocaleDateString('vi-VN') : '-'}</td>
        <td class="text-end fw-semibold">${formatQty(lot.qty)}</td>
        <td>
          <input type="number" 
                 class="form-control form-control-sm lot-qty-input" 
                 data-detail-id="${detailId}"
                 data-lot-id="${lot.lotId}"
                 data-max="${lot.qty}"
                 min="0" 
                 max="${lot.qty}"
                 step="0.01"
                 value="0"
                 placeholder="0">
        </td>
      </tr>`;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;

    // Gắn sự kiện cho các input
    container.querySelectorAll('.lot-qty-input').forEach(input => {
      input.addEventListener('input', () => updateAllocation(detailId, requiredQty));
      input.addEventListener('blur', () => {
        const max = parseFloat(input.dataset.max);
        let val = parseFloat(input.value) || 0;
        if(val > max) val = max;
        if(val < 0) val = 0;
        input.value = val;
        updateAllocation(detailId, requiredQty);
      });
    });
  }

  // Tự động phân bổ FEFO
  modal.addEventListener('click', (e) => {
    const btn = e.target.closest('.auto-allocate-btn');
    if(!btn) return;

    const detailId = btn.dataset.detailId;
    const requiredQty = parseFloat(btn.dataset.requiredQty);
    const lots = lotsData[detailId];

    if(!lots || lots.length === 0) {
      alert('Vui lòng tải danh sách lô trước');
      return;
    }

    // Reset tất cả
    const inputs = modal.querySelectorAll(`.lot-qty-input[data-detail-id="${detailId}"]`);
    inputs.forEach(inp => inp.value = 0);

    // Phân bổ FEFO
    let remain = requiredQty;
    inputs.forEach(inp => {
      if(remain <= 0) return;
      const max = parseFloat(inp.dataset.max);
      const take = Math.min(max, remain);
      inp.value = take;
      remain -= take;
    });

    updateAllocation(detailId, requiredQty);
  });

  // Cập nhật tổng phân bổ
  function updateAllocation(detailId, requiredQty) {
    const inputs = modal.querySelectorAll(`.lot-qty-input[data-detail-id="${detailId}"]`);
    let total = 0;
    inputs.forEach(inp => total += parseFloat(inp.value) || 0);

    const allocatedEl = modal.querySelector(`.allocated-qty[data-detail-id="${detailId}"]`);
    const statusEl = modal.querySelector(`.allocated-status[data-detail-id="${detailId}"]`);

    if(allocatedEl) allocatedEl.textContent = formatQty(total);

    if(statusEl) {
      if(Math.abs(total - requiredQty) < 0.01) {
        statusEl.innerHTML = '<small class="text-success">✓ Đã phân bổ đủ</small>';
      } else if(total > requiredQty) {
        statusEl.innerHTML = '<small class="text-warning">⚠️ Phân bổ vượt quá yêu cầu</small>';
      } else {
        statusEl.innerHTML = '<small class="text-danger">⚠️ Chưa phân bổ đủ</small>';
      }
    }

    checkGlobalValidation();
  }

  // Kiểm tra toàn bộ phiếu
  function checkGlobalValidation() {
    const allDetails = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      Model.Details?.Select(d => new { id = d.Id, qty = Convert.ToDecimal(d.Quantity) }) ?? Enumerable.Empty<object>()
    ));

    let allValid = true;
    let errorMsg = '';

    allDetails.forEach(d => {
      const inputs = modal.querySelectorAll(`.lot-qty-input[data-detail-id="${d.id}"]`);
      if(inputs.length === 0) {
        allValid = false;
        errorMsg = 'Vui lòng tải danh sách lô cho tất cả vật tư';
        return;
      }

      let total = 0;
      inputs.forEach(inp => total += parseFloat(inp.value) || 0);

      if(Math.abs(total - d.qty) >= 0.01) {
        allValid = false;
        errorMsg = 'Các vật tư chưa được phân bổ đủ hoặc vượt quá';
      }
    });

    const submitBtn = modal.querySelector('#confirmIssueBtn-@Model.Id');
    const errorEl = modal.querySelector('#globalError-@Model.Id');
    
    if(submitBtn) submitBtn.disabled = !allValid;
    if(errorEl) errorEl.textContent = allValid ? '' : errorMsg;
  }

  // Khi submit form
  let isSubmitting = false;
  modal.querySelector('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Chặn double submit
    if(isSubmitting) {
      console.warn('Form đang submit, vui lòng chờ...');
      return;
    }
    
    isSubmitting = true;
    const form = e.target;
    const submitBtn = modal.querySelector('#confirmIssueBtn-@Model.Id');
    const originalBtnText = submitBtn.innerHTML;
    
    // Disable nút và hiển thị loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang xuất hàng...';
    
    try {
      const formData = new FormData(form);

      // Thu thập dữ liệu phân bổ
      const allocations = [];
      const inputs = modal.querySelectorAll('.lot-qty-input');
      inputs.forEach(inp => {
        const qty = parseFloat(inp.value) || 0;
        if(qty > 0) {
          allocations.push({
            detailId: parseInt(inp.dataset.detailId),
            lotId: parseInt(inp.dataset.lotId),
            qty: qty
          });
        }
      });

      console.log('Submitting allocations:', allocations);
      formData.append('allocationsJson', JSON.stringify(allocations));

      // Submit
      const res = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      
      if(res.ok) {
        window.location.reload();
      } else {
        alert('Lỗi xuất hàng. Vui lòng thử lại.');
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    } catch(err) {
      alert('Lỗi kết nối: ' + err.message);
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    }
  });

  function formatQty(v) {
    return (v % 1 === 0) ? String(v|0) : parseFloat(v).toFixed(2).replace(/\.?0+$/, '');
  }

  // Tự động load lô cho item đầu tiên khi mở modal
  modal.addEventListener('shown.bs.modal', () => {
    setTimeout(() => {
      const firstLoadBtn = modal.querySelector('.load-lots-btn');
      if(firstLoadBtn && !firstLoadBtn.disabled) {
        firstLoadBtn.click();
      }
    }, 300);
  });
})();
</script>
