@model MNBEMART.Models.StockIssue
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    var materials = (IEnumerable<MNBEMART.Models.Material>)(ViewBag.Materials ?? Enumerable.Empty<MNBEMART.Models.Material>());
}

<div class="modal fade" id="siCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-md-down modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">T·∫°o phi·∫øu xu·∫•t</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
      </div>

      <form asp-controller="StockIssues" asp-action="CreateIssue" method="post" id="issueForm" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-lg-3">
              <div class="border rounded p-3 bg-light">
                <div class="mb-3">
                  <label class="form-label">Kho xu·∫•t <span class="text-danger">*</span></label>
                  <select asp-for="WarehouseId" class="form-select" asp-items="ViewBag.WarehouseOptions" required>
                    <option value="">-- Ch·ªçn kho --</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ng∆∞·ªùi Nh·∫≠n <span class="text-danger">*</span></label>
                  <input asp-for="ReceivedByName" class="form-control" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">H√¨nh ·∫£nh minh ch·ª©ng <span class="text-danger">*</span></label>
                  <input type="file" name="EvidenceImage" id="EvidenceImage" class="form-control" accept="image/*" required>
                  <div class="form-text">Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh (JPG, PNG, GIF, WEBP). T·ªëi ƒëa 10MB</div>
                  <div id="evidenceImageError" class="text-danger small mt-1"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ghi ch√∫</label>
                  <textarea asp-for="Note" rows="3" class="form-control"></textarea>
                </div>
                <div class="small text-muted">Ng∆∞·ªùi l·∫≠p: @User.Identity?.Name</div>
              </div>
            </div>

            <div class="col-lg-9">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group input-group-sm" style="max-width:520px">
                  <span class="input-group-text">üîç</span>
                  <input id="matSearchOut" class="form-control" placeholder="Nh·∫≠p t√™n, m√£ v·∫≠t t∆∞...">
                </div>
                <button type="button" id="btnAddEmpty" class="btn btn-outline-secondary btn-sm">+ Th√™m d√≤ng tr·ªëng</button>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle" id="issueDetailsTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width:30%">S·∫£n ph·∫©m</th>
                      <th>Ghi ch√∫</th>
                      <th style="width:10%" class="text-end">SL</th>
                      <th style="width:12%" class="text-end">T·ªìn (kho ch·ªçn)</th>  @* th√™m *@
                      <th style="width:12%" class="text-end">Gi√° xu·∫•t</th>
                      <th style="width:10%">ƒêVT</th>
                      <th style="width:8%"></th>
                    </tr>
                  </thead>
                  <tbody id="issueDetailBody"></tbody>
                </table>
              </div>

              <div class="d-flex justify-content-end mt-2">
                <div class="text-end">
                  <div><strong>T·ªïng SL:</strong> <span id="sumItemsOut">0</span></div>
                  <div><strong>T·ªïng ti·ªÅn xu·∫•t:</strong> <span id="sumAmountOut">0 ƒë</span></div>
                </div>
              </div>

              <div class="text-muted small mt-1">* Nh·∫•n Enter trong √¥ t√¨m ki·∫øm ƒë·ªÉ th√™m d√≤ng nhanh</div>
              <div class="text-muted small">* T·ª± ch·∫∑n ch·ªçn tr√πng v·∫≠t t∆∞</div>

              <!-- Footer d√≠nh LU√îN TH·∫§Y -->
              <div class="sticky-actions">
                <div class="me-auto text-danger" id="formErrorOut"></div>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="submit" class="btn btn-primary" id="btnSubmitOut">T·∫°o</button>
              </div>
              
            </div>
          </div>
        </div> <!-- /modal-body -->
      </form>
    </div>
  </div>
</div>

<style>
  /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc modal h·ª£p l√Ω */
  #siCreateModal .modal-dialog {
    max-width: 95vw;
    max-height: 95vh;
    margin: 1rem auto;
  }
  
  #siCreateModal .modal-content {
    max-height: 95vh;
    display: flex;
    flex-direction: column;
  }
  
  #siCreateModal .modal-body {
    overflow-y: auto;
    padding: 1.25rem;
    flex: 1 1 auto;
  }
  
  /* C·∫£i thi·ªán spacing trong form */
  #siCreateModal .border.rounded {
    padding: 1rem !important;
  }
  
  #siCreateModal .form-label {
    margin-bottom: 0.5rem;
    font-weight: 500;
  }
  
  #siCreateModal .mb-3 {
    margin-bottom: 1rem !important;
  }
  
  /* ƒêi·ªÅu ch·ªânh table spacing v√† scroll khi c√≥ nhi·ªÅu d√≤ng */
  #siCreateModal .table-responsive {
    margin-bottom: 1rem;
    max-height: 450px;
    overflow-y: auto;
    overflow-x: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    position: relative;
  }
  
  /* Sticky header khi scroll */
  #siCreateModal .table-responsive .table thead {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
  }
  
  /* Hover effect cho table rows */
  #siCreateModal .table tbody tr {
    transition: background-color 0.15s ease-in-out;
  }
  
  #siCreateModal .table tbody tr:hover {
    background-color: #f8f9fa;
  }
  
  #siCreateModal .table {
    margin-bottom: 0.5rem;
  }
  
  /* Custom scrollbar styling */
  #siCreateModal .table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  #siCreateModal .table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  #siCreateModal .table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  #siCreateModal .table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  
  /* Firefox scrollbar */
  #siCreateModal .table-responsive {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
  }
  
  /* Action bar d√≠nh cu·ªëi c·ªôt ph·∫£i, kh√¥ng b·ªã CSS global ·∫©n */
  #siCreateModal .sticky-actions{
    position: sticky;
    bottom: 0;
    background: #fff;
    border-top: 1px solid #e9ecef;
    padding: .75rem;
    display: flex;
    gap: .5rem;
    justify-content: flex-end;
    z-index: 10;
    margin-top: 0.5rem;
  }
  
  /* Cho ph√©p cu·ªôn trang ph√≠a sau modal phi·∫øu xu·∫•t (gi·ªëng modal phi·∫øu nh·∫≠p) */
  body.modal-open.allow-scroll {
    overflow: auto !important;
    padding-right: 0 !important;
  }
  
  /* Responsive cho m√†n h√¨nh nh·ªè */
  @@media (max-width: 992px) {
    #siCreateModal .modal-dialog {
      max-width: 98vw;
      margin: 0.5rem auto;
    }
    
    #siCreateModal .modal-body {
      padding: 1rem;
    }
  }
</style>

@* <script>
(function(){
  const modal = document.getElementById('siCreateModal') || document.getElementById('createIssueModal');
  if(!modal){ console.warn('Kh√¥ng t√¨m th·∫•y modal siCreateModal/createIssueModal'); return; }

  // DATA v·∫≠t t∆∞
  const mats = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    materials.Select(m => new { m.Id, m.Code, m.Name, m.Unit, m.Specification, m.PurchasePrice })
  ));

  // ====== C√ÅC GETTER KH·ªöP V·ªöI ID ·ªû HTML ======
  const tbody      = () => modal.querySelector('#issueDetailBody');
  const search     = () => modal.querySelector('#matSearchOut');
  const sumItemsEl = () => modal.querySelector('#sumItemsOut');
  const sumAmtEl   = () => modal.querySelector('#sumAmountOut');
  const whSel      = () => modal.querySelector('#WarehouseId');
  const submitBtn  = () => modal.querySelector('#btnSubmitOut');
  const errorBox   = () => modal.querySelector('#formErrorOut');

  let onhandCache = {}; // key: `${wid}:${matId}` -> number

  function uid(){ return (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'k'+Date.now()+Math.random().toString(16).slice(2); }

  function refreshOptionStates(){
    const selects = modal.querySelectorAll('.mat-select');
    const chosen  = new Set([...selects].map(s => s.value).filter(Boolean));
    selects.forEach(sel => {
      const keep = sel.value;
      [...sel.options].forEach(opt => {
        if(!opt.value) return;
        opt.disabled = (chosen.has(opt.value) && opt.value !== keep);
      });
    });
  }

  function notifyDup(){ alert('S·∫£n ph·∫©m n√†y ƒë√£ ƒë∆∞·ª£c ch·ªçn ·ªü d√≤ng kh√°c. Vui l√≤ng ch·ªçn s·∫£n ph·∫©m kh√°c.'); }

  function renderRow(prefill){
    const key = uid();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="hidden" name="Details.index" value="${key}" />
        <select name="Details[${key}].MaterialId" class="form-select form-select-sm mat-select">
          <option value="">-- Ch·ªçn --</option>
          ${mats.map(m => `<option value="${m.Id}">${(m.Code ?? '').trim()} ${m.Name}</option>`).join('')}
        </select>
      </td>
      <td><input name="Details[${key}].Specification" class="form-control form-control-sm" placeholder="Ghi ch√∫ d√≤ng"/></td>
      <td><input name="Details[${key}].Quantity" type="number" min="1" step="1" class="form-control form-control-sm text-end qty" value="${prefill?.q ?? 1}"/></td>
      <td class="text-end">
        <span class="onhand" data-onhand="0">‚Äî</span>
      </td>
      <td><input name="Details[${key}].UnitPrice" type="number" min="0" step="0.01" class="form-control form-control-sm text-end price" value="${prefill?.p ?? 0}"/></td>
      <td><input name="Details[${key}].Unit" class="form-control form-control-sm unit"/></td>
      <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm del">‚úï</button>
      </td>`;
    tbody().appendChild(tr);

    const sel = tr.querySelector('.mat-select');
    sel.addEventListener('change', (e)=>{
      const val = e.target.value;
      if(!val){ refreshOptionStates(); return; }
      const dup = [...modal.querySelectorAll('.mat-select')].some(s => s !== sel && s.value === val);
      if(dup){
        notifyDup();
        sel.value = "";
        tr.querySelector('.unit').value = '';
        tr.querySelector('.qty').value = 1;
        tr.querySelector('input[name$=".Specification"]').value = '';
        tr.querySelector('.price').value = '';
        refreshOptionStates();
        return;
      }
      const m = mats.find(x => String(x.Id) === String(val));
      tr.querySelector('.unit').value = m ? (m.Unit || '') : '';
      tr.querySelector('.qty').value = 1;
      tr.querySelector('input[name$=".Specification"]').value = m ? (m.Specification || '') : '';
      if(m && m.PurchasePrice != null) tr.querySelector('.price').value = m.PurchasePrice;
      refreshOptionStates();
      calc();
    });

    tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); refreshOptionStates(); calc(); });

    const qty = tr.querySelector('.qty');
    qty.addEventListener('input', ()=>{ qty.value = qty.value.replace(/[^\d]/g,''); calc(); });
    qty.addEventListener('blur', ()=>{ qty.value = Math.max(1, Math.floor(Number(qty.value||1))); calc(); });

    tr.querySelector('.price').addEventListener('input', calc);

    calc();
    refreshOptionStates();
  }

  function calc(){
    let items = 0, amount = 0;
    tbody().querySelectorAll('tr').forEach(tr=>{
      const q = Number(tr.querySelector('.qty')?.value || 0);
      const p = Number(tr.querySelector('.price')?.value || 0);
      if(q>0){ items += q; amount += q*p; }
    });
    if(sumItemsEl()) sumItemsEl().textContent = items.toLocaleString('vi-VN');
    if(sumAmtEl())   sumAmtEl().textContent   = amount.toLocaleString('vi-VN') + ' ƒë';
  }

  // Khi m·ªü modal
  modal.addEventListener('shown.bs.modal', ()=>{
    if(tbody()){ tbody().innerHTML = ''; renderRow(); }
    if(search()){ search().value=''; setTimeout(()=>search().focus(), 150); }
    refreshOptionStates();
  });

  // N√∫t "Th√™m d√≤ng tr·ªëng"
  modal.addEventListener('click', (e)=>{
    const btn = e.target.closest('#btnAddEmpty');
    if(!btn) return;
    e.preventDefault();
    renderRow();
  });

  // Enter trong √¥ t√¨m ki·∫øm -> th√™m d√≤ng
  document.addEventListener('keydown', (e)=>{
    if(search() && document.activeElement === search() && e.key === 'Enter'){
      e.preventDefault();
      renderRow();
    }
  });
})();
</script> *@
<script>
(function(){
  try {
    console.log('[StockIssues Modal] Initializing...');
    const modal = document.getElementById('siCreateModal');
    if(!modal) {
      console.warn('[StockIssues Modal] Modal element not found');
      return;
    }

    const baseOnHandUrl = '@Url.Action("OnHand","StockIssues")'; // ‚úÖ server render s·∫µn
    const mats = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      materials.Select(m => new { m.Id, m.Code, m.Name, m.Unit, m.Specification, m.SellingPrice })
    ));

    // ƒê·∫£m b·∫£o c√°c h√†m getter tr·∫£ v·ªÅ gi√° tr·ªã an to√†n, kh√¥ng throw l·ªói
    const tbody      = () => {
      try { return modal?.querySelector('#issueDetailBody') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting tbody:', e); return null; }
    };
    const search     = () => {
      try { return modal?.querySelector('#matSearchOut') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting search:', e); return null; }
    };
    const sumItemsEl = () => {
      try { return modal?.querySelector('#sumItemsOut') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting sumItemsEl:', e); return null; }
    };
    const sumAmtEl   = () => {
      try { return modal?.querySelector('#sumAmountOut') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting sumAmtEl:', e); return null; }
    };
    const whSel      = () => {
      try { return modal?.querySelector('#WarehouseId') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting whSel:', e); return null; }
    };
    const submitBtn  = () => {
      try { return modal?.querySelector('#btnSubmitOut') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting submitBtn:', e); return null; }
    };
    const errorBox   = () => {
      try { return modal?.querySelector('#formErrorOut') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting errorBox:', e); return null; }
    };
    const evidenceFile = () => {
      try { return modal?.querySelector('#EvidenceImage') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting evidenceFile:', e); return null; }
    };
    const evidenceError = () => {
      try { return modal?.querySelector('#evidenceImageError') || null; } 
      catch(e) { console.error('[StockIssues Modal] Error getting evidenceError:', e); return null; }
    };

    let onhandCache = {}; // key: `${wid}:${matId}` -> number
    let isModalInitialized = false; // Flag ƒë·ªÉ tr√°nh validation qu√° s·ªõm

  function uid(){ return (crypto?.randomUUID ? crypto.randomUUID() : 'k'+Date.now()+Math.random().toString(16).slice(2)); }

  function refreshOptionStates(){
    const selects = modal.querySelectorAll('.mat-select');
    const chosen  = new Set([...selects].map(s => s.value).filter(Boolean));
    selects.forEach(sel => {
      const keep = sel.value;
      [...sel.options].forEach(opt => {
        if(!opt.value) return;
        opt.disabled = (chosen.has(opt.value) && opt.value !== keep);
      });
    });
  }

  function renderRow(prefill){
    try {
      const tbodyEl = tbody();
      if (!tbodyEl) {
        console.warn('[StockIssues Modal] tbody not found');
        return;
      }

      const key = uid();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <input type="hidden" name="Details.index" value="${key}" />
          <select name="Details[${key}].MaterialId" class="form-select form-select-sm mat-select" required>
            <option value="">-- Ch·ªçn --</option>
            ${mats.map(m => `<option value="${m.Id}">${(m.Code ?? '').trim()} ${m.Name}</option>`).join('')}
          </select>
        </td>
        <td><input name="Details[${key}].Specification" class="form-control form-control-sm" placeholder="Ghi ch√∫ d√≤ng"/></td>
        <td><input name="Details[${key}].Quantity" type="number" min="1" step="1" class="form-control form-control-sm text-end qty" value="${prefill?.q ?? 1}" required/></td>
        <td class="text-end"><span class="onhand" data-onhand="0">‚Äî</span></td>
        <td><input name="Details[${key}].UnitPrice" type="number" min="0" step="0.01" class="form-control form-control-sm text-end price" value="${prefill?.p ?? 0}" readonly style="background-color: #e9ecef;" required/></td>
        <td><input name="Details[${key}].Unit" class="form-control form-control-sm unit" required/></td>
        <td class="text-center">
          <button type="button" class="btn btn-outline-danger btn-sm del">‚úï</button>
        </td>`;
      tbodyEl.appendChild(tr);

    const sel  = tr.querySelector('.mat-select');
    const qtyI = tr.querySelector('.qty');
    const priceI = tr.querySelector('.price');


    sel.addEventListener('change', async (e)=>{
      const val = e.target.value;
      if(!val){ refreshOptionStates(); updateRowOnHand(tr); calc(); validateForm(); return; }

      // ch·∫∑n tr√πng
      const dup = [...modal.querySelectorAll('.mat-select')].some(s => s !== sel && s.value === val);
      if(dup){ alert('S·∫£n ph·∫©m ƒë√£ ch·ªçn ·ªü d√≤ng kh√°c.'); sel.value=''; refreshOptionStates(); updateRowOnHand(tr); calc(); validateForm(); return; }

      // fill nhanh
      const m = mats.find(x => String(x.Id) === String(val));
      tr.querySelector('.unit').value = m ? (m.Unit || '') : '';
      tr.querySelector('input[name$=".Specification"]').value = m ? (m.Specification || '') : '';
      if(m && m.SellingPrice != null) priceI.value = m.SellingPrice;


      refreshOptionStates();

      // n·∫°p t·ªìn theo kho ƒë√£ ch·ªçn
      await ensureOnHand([val]);
      updateRowOnHand(tr);
      validateRow(tr);
      calc();
      validateForm();
    });

    qtyI.addEventListener('input', ()=>{ validateRow(tr); calc(); validateForm(); });
    // Gi√° xu·∫•t l√† readonly, kh√¥ng c·∫ßn event listener cho input
    // priceI.addEventListener('input', ()=>{ calc(); validateForm(); });
    tr.querySelector('.unit')?.addEventListener('input', validateForm);

    tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); refreshOptionStates(); calc(); validateForm(); });

      updateRowOnHand(tr);
      validateRow(tr);
      calc();
      // Ch·ªâ validate n·∫øu modal ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o
      if (isModalInitialized) {
        validateForm();
      }
    } catch (error) {
      console.error('[StockIssues Modal] Error in renderRow:', error);
    }
  }

  function getWarehouseId(){
    const v = whSel()?.value;
    return v ? parseInt(v,10) : 0;
  }

  async function ensureOnHand(materialIds){
    const wid = getWarehouseId();
    if(!wid || !materialIds?.length) return;

    const need = materialIds.filter(id => onhandCache[`${wid}:${id}`] == null);
    if(!need.length) return;

    try{
      // ‚úÖ build URL ƒë√∫ng
      const url = `${baseOnHandUrl}?warehouseId=${encodeURIComponent(wid)}&ids=${encodeURIComponent(need.join(','))}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      const data = await res.json();
      data.forEach(x => onhandCache[`${wid}:${x.materialId}`] = Number(x.qty) || 0);
      need.forEach(id => { const k = `${wid}:${id}`; if(onhandCache[k] == null) onhandCache[k] = 0; });
    }catch{ /* ignore */ }
  }

  function updateRowOnHand(tr){
    const wid = getWarehouseId();
    const sel = tr.querySelector('.mat-select');
    const ohSpan = tr.querySelector('.onhand');
    if(!ohSpan) return;

    const matId = sel?.value;
    if(!wid || !matId){
      ohSpan.dataset.onhand = '0';
      ohSpan.textContent = '‚Äî';
      return;
    }
    const key = `${wid}:${matId}`;
    const v = onhandCache[key];
    if(v == null) { ohSpan.dataset.onhand = '0'; ohSpan.textContent = '...'; }
    else { ohSpan.dataset.onhand = String(v); ohSpan.textContent = fmtQty(v); }
  }

  function validateRow(tr){
    const qtyI = tr.querySelector('.qty');
    const ohSpan = tr.querySelector('.onhand');
    qtyI.classList.remove('is-invalid');

    const q = Number(qtyI.value || 0);
    const onhand = Number(ohSpan?.dataset.onhand || 0);
    if(q > onhand) qtyI.classList.add('is-invalid');
  }

  function fmtQty(v){ return (v % 1 === 0) ? String(v|0) : v.toFixed(2).replace(/\.?0+$/,''); }

  function validateForm(){
    try {
      // Kh√¥ng validate n·∫øu modal ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o ƒë·∫ßy ƒë·ªß
      if (!isModalInitialized) {
        return true;
      }

      const form = modal.querySelector('#issueForm');
      const errorBox = modal.querySelector('#formErrorOut');
      const submitBtn = modal.querySelector('#btnSubmitOut');
      if(!form || !errorBox) return true;

    // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc ·ªü form ch√≠nh
    const warehouseId = getWarehouseId();
    const receivedByName = form.querySelector('#ReceivedByName')?.value?.trim();
    const evidenceFileEl = modal.querySelector('#EvidenceImage');
    const evidenceFileValue = evidenceFileEl?.files?.[0];

    // Validate evidence image
    let imageError = '';
    if (!evidenceFileValue) {
      imageError = 'Vui l√≤ng ch·ªçn h√¨nh ·∫£nh minh ch·ª©ng.';
    } else {
      if (!evidenceFileValue.type.startsWith('image/')) {
        imageError = 'File ph·∫£i l√† h√¨nh ·∫£nh (JPG, PNG, GIF, WEBP).';
      } else if (evidenceFileValue.size > 10 * 1024 * 1024) {
        imageError = 'K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 10MB.';
      }
    }
    if(evidenceError()) evidenceError().textContent = imageError;

    // Ki·ªÉm tra c√°c d√≤ng s·∫£n ph·∫©m
    const rows = tbody().querySelectorAll('tr');
    let hasValidRow = false;
    let anyInvalid = false;
    let rowErrors = [];

    rows.forEach((tr, index) => {
      const materialId = tr.querySelector('.mat-select')?.value;
      const qty = tr.querySelector('.qty')?.value;
      const price = tr.querySelector('.price')?.value;
      const unit = tr.querySelector('.unit')?.value?.trim();
      
      // Ki·ªÉm tra v∆∞·ª£t t·ªìn
      if(tr.querySelector('.qty')?.classList.contains('is-invalid')) anyInvalid = true;

      if(materialId && qty && price && unit && Number(qty) > 0 && Number(price) >= 0){
        hasValidRow = true;
      } else if(materialId || qty || price || unit){
        // C√≥ m·ªôt ph·∫ßn d·ªØ li·ªáu nh∆∞ng ch∆∞a ƒë·ªß
        const missingFields = [];
        if(!materialId) missingFields.push('S·∫£n ph·∫©m');
        if(!qty || Number(qty) <= 0) missingFields.push('SL');
        if(!price || Number(price) < 0) missingFields.push('Gi√° xu·∫•t');
        if(!unit) missingFields.push('ƒêVT');
        rowErrors.push(`D√≤ng ${index + 1}: Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin (${missingFields.join(', ')}).`);
      }
    });

    let errors = [];
    if(warehouseId <= 0) errors.push('Vui l√≤ng ch·ªçn kho xu·∫•t.');
    if(!receivedByName) errors.push('Vui l√≤ng nh·∫≠p ng∆∞·ªùi nh·∫≠n.');
    if(imageError) errors.push(imageError);
    if(anyInvalid) errors.push('C√≥ d√≤ng v∆∞·ª£t t·ªìn kho. Vui l√≤ng gi·∫£m s·ªë l∆∞·ª£ng.');
    if(!hasValidRow) errors.push('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 d√≤ng s·∫£n ph·∫©m v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin (S·∫£n ph·∫©m, SL, Gi√° xu·∫•t, ƒêVT).');
    if(rowErrors.length > 0) errors.push(...rowErrors);

    if(errors.length > 0){
      errorBox.textContent = errors[0];
      errorBox.style.display = 'block';
      if(submitBtn) submitBtn.disabled = true;
      return false;
    } else {
      errorBox.textContent = '';
      errorBox.style.display = 'none';
      if(submitBtn) submitBtn.disabled = false;
      return true;
    }
    } catch (error) {
      console.error('[StockIssues Modal] Error in validateForm:', error);
      return true; // Tr·∫£ v·ªÅ true ƒë·ªÉ kh√¥ng block form submission n·∫øu c√≥ l·ªói
    }
  }

  function calc(){
    try {
      let items = 0, amount = 0;
      const tbodyEl = tbody();
      if (!tbodyEl) return;
      
      tbodyEl.querySelectorAll('tr').forEach(tr=>{
        const q = Number(tr.querySelector('.qty')?.value || 0);
        const p = Number(tr.querySelector('.price')?.value || 0);
        if(q>0){ items += q; amount += q*p; }
      });

      if(sumItemsEl()) sumItemsEl().textContent = items.toLocaleString('vi-VN');
      if(sumAmtEl())   sumAmtEl().textContent   = amount.toLocaleString('vi-VN') + ' ƒë';
      
      // Ch·ªâ validate n·∫øu modal ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o
      if (isModalInitialized) {
        validateForm();
      }
    } catch (error) {
      console.error('[StockIssues Modal] Error in calc:', error);
    }
  }

  // ƒë·ªïi kho -> n·∫°p t·ªìn cho t·∫•t c·∫£ d√≤ng
  modal.addEventListener('change', async (e)=>{
    if(e.target && e.target.id === 'WarehouseId'){
      const ids = [...modal.querySelectorAll('.mat-select')].map(s => s.value).filter(Boolean);
      await ensureOnHand(ids);
      tbody().querySelectorAll('tr').forEach(tr => { updateRowOnHand(tr); validateRow(tr); });
      calc();
      validateForm();
    }
    // Validate evidence image on change
    if(e.target && e.target.id === 'EvidenceImage'){
      validateForm();
    }
  });

  // Validate khi ReceivedByName thay ƒë·ªïi
  modal.addEventListener('input', (e)=>{
    if(e.target && e.target.id === 'ReceivedByName'){
      validateForm();
    }
  });

  // Validate tr∆∞·ªõc khi submit
  const form = modal.querySelector('#issueForm');
  form?.addEventListener('submit', (e)=>{
    if(!validateForm()){
      e.preventDefault();
      return false;
    }
  });

  // N√∫t th√™m d√≤ng (h·ªó tr·ª£ c·∫£ 2 id c≈©/m·ªõi)
  modal.addEventListener('click', (e)=>{
    const btn = e.target.closest('#btnAddEmpty, #btnAddEmptyOut');
    if(!btn) return;
    e.preventDefault();
    renderRow();
  });

  // Enter trong √¥ t√¨m ki·∫øm
  document.addEventListener('keydown', (e)=>{
    if(search() && document.activeElement === search() && e.key === 'Enter'){
      e.preventDefault();
      renderRow();
    }
  });

  // NgƒÉn modal t·ª± ƒë√≥ng khi c√≥ l·ªói ho·∫∑c trong 500ms ƒë·∫ßu
  let preventAutoClose = false;
  let modalOpenTime = 0;
  
  modal.addEventListener('hide.bs.modal', function(e) {
    const timeSinceOpen = Date.now() - modalOpenTime;
    
    // NgƒÉn ƒë√≥ng trong 500ms ƒë·∫ßu ho·∫∑c khi c√≥ flag preventAutoClose
    if (preventAutoClose || timeSinceOpen < 500) {
      console.warn('[StockIssues Modal] Preventing auto-close - timeSinceOpen:', timeSinceOpen, 'ms, preventAutoClose:', preventAutoClose);
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      if (preventAutoClose) {
        preventAutoClose = false; // Reset sau khi prevent
      }
      return false;
    }
  });

  // Khi m·ªü modal -> reset
  modal.addEventListener('show.bs.modal', (e)=>{
    console.log('[StockIssues Modal] show.bs.modal event fired');
    preventAutoClose = false; // Reset flag
    modalOpenTime = Date.now(); // Ghi l·∫°i th·ªùi gian m·ªü modal
    
    // ƒê·∫£m b·∫£o config ngƒÉn ƒë√≥ng
    try {
      const bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) {
        bsModal._config.backdrop = 'static';
        bsModal._config.keyboard = false;
      }
    } catch (err) {
      console.warn('[StockIssues Modal] Error setting modal config:', err);
    }
  });

  modal.addEventListener('shown.bs.modal', ()=>{
    console.log('[StockIssues Modal] shown.bs.modal event fired');
    try {
      isModalInitialized = false; // Reset flag
      preventAutoClose = true; // B·∫≠t flag ƒë·ªÉ ngƒÉn auto-close
      
      // Delay ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ ho√†n to√†n s·∫µn s√†ng tr∆∞·ªõc khi thao t√°c
      setTimeout(() => {
        try {
          const tbodyEl = tbody();
          if (tbodyEl) {
            tbodyEl.innerHTML = '';
            // Delay th√™m m·ªôt ch√∫t tr∆∞·ªõc khi render row ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ ·ªïn ƒë·ªãnh
            setTimeout(() => {
              try {
                renderRow();
              } catch (error) {
                console.error('[StockIssues Modal] Error in renderRow:', error);
                preventAutoClose = false; // Cho ph√©p ƒë√≥ng n·∫øu c√≥ l·ªói nghi√™m tr·ªçng
              }
            }, 100);
          }
          
          const searchEl = search();
          if (searchEl) {
            searchEl.value = '';
            setTimeout(() => {
              try {
                searchEl.focus();
              } catch (e) {
                console.warn('[StockIssues Modal] Could not focus search:', e);
              }
            }, 200);
          }
          
          const evidenceFileEl = evidenceFile();
          if (evidenceFileEl) {
            evidenceFileEl.value = '';
          }
          
          const evidenceErrorEl = evidenceError();
          if (evidenceErrorEl) {
            evidenceErrorEl.textContent = '';
          }
          
          onhandCache = {};
          
          // Delay ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render xong tr∆∞·ªõc khi t√≠nh to√°n v√† validate
          setTimeout(() => {
            try {
              calc();
              isModalInitialized = true; // ƒê√°nh d·∫•u modal ƒë√£ s·∫µn s√†ng
              preventAutoClose = false; // T·∫Øt flag sau khi m·ªçi th·ª© ƒë√£ ·ªïn ƒë·ªãnh
              
              // G·ªçi validateForm v·ªõi delay nh·ªè h∆°n n·ªØa ƒë·ªÉ ƒë·∫£m b·∫£o m·ªçi th·ª© ƒë√£ s·∫µn s√†ng
              setTimeout(() => {
                try {
                  validateForm();
                } catch (error) {
                  console.error('[StockIssues Modal] Error in validateForm:', error);
                }
              }, 50);
            } catch (error) {
              console.error('[StockIssues Modal] Error in shown.bs.modal setTimeout:', error);
              preventAutoClose = false; // Cho ph√©p ƒë√≥ng n·∫øu c√≥ l·ªói
            }
          }, 200);
          
          // Cho ph√©p cu·ªôn trang ph√≠a sau modal
          try {
            document.body.classList.add('allow-scroll');
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '0';
          } catch (e) {
            console.warn('[StockIssues Modal] Error setting body styles:', e);
          }
        } catch (error) {
          console.error('[StockIssues Modal] Error in shown.bs.modal setTimeout:', error);
          preventAutoClose = false; // Cho ph√©p ƒë√≥ng n·∫øu c√≥ l·ªói nghi√™m tr·ªçng
        }
      }, 100); // Delay ban ƒë·∫ßu ƒë·ªÉ ƒë·∫£m b·∫£o modal ƒë√£ ho√†n to√†n hi·ªÉn th·ªã
      
    } catch (error) {
      console.error('[StockIssues Modal] Error in shown.bs.modal:', error);
      preventAutoClose = false; // Cho ph√©p ƒë√≥ng n·∫øu c√≥ l·ªói nghi√™m tr·ªçng
    }
  });

  // Khi ƒë√≥ng modal -> kh√¥i ph·ª•c
  modal.addEventListener('hidden.bs.modal', ()=>{
    console.log('[StockIssues Modal] hidden.bs.modal event fired');
    try {
      isModalInitialized = false; // Reset flag
      document.body.classList.remove('allow-scroll');
      // Kh√¥i ph·ª•c l·∫°i style m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≤n modal n√†o kh√°c m·ªü
      const otherModals = document.querySelectorAll('.modal.show');
      if (otherModals.length === 0) {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
    } catch (error) {
      console.error('[StockIssues Modal] Error in hidden.bs.modal:', error);
    }
  });

  console.log('[StockIssues Modal] Initialization complete');
  } catch (error) {
    console.error('[StockIssues Modal] Fatal error during initialization:', error);
  }
})();
</script>
