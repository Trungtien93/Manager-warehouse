@model MNBEMART.Models.StockIssue
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    var materials = (IEnumerable<MNBEMART.Models.Material>)(ViewBag.Materials ?? Enumerable.Empty<MNBEMART.Models.Material>());
}

<div class="modal fade" id="siCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-md-down modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">T·∫°o phi·∫øu xu·∫•t</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
      </div>

      <form asp-controller="StockIssues" asp-action="CreateIssue" method="post" id="issueForm">
        @Html.AntiForgeryToken()
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-lg-3">
              <div class="border rounded p-3 bg-light">
                <div class="mb-3">
                  <label class="form-label">Kho xu·∫•t</label>
                  <select asp-for="WarehouseId" class="form-select" asp-items="ViewBag.WarehouseOptions">
                    <option value="">-- Ch·ªçn kho --</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ng∆∞·ªùi Nh·∫≠n</label>
                  <input asp-for="ReceivedByName" class="form-control"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">S·ªë ch·ª©ng t·ª´ g·ªëc</label>
                  <input asp-for="ReferenceDocumentNumber" class="form-control"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ng√†y ch·ª©ng t·ª´</label>
                  <input asp-for="ReferenceDate" type="date" class="form-control"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ghi ch√∫</label>
                  <textarea asp-for="Note" rows="3" class="form-control"></textarea>
                </div>
                <div class="small text-muted">Ng∆∞·ªùi l·∫≠p: @User.Identity?.Name</div>
              </div>
            </div>

            <div class="col-lg-9">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group input-group-sm" style="max-width:520px">
                  <span class="input-group-text">üîç</span>
                  <input id="matSearchOut" class="form-control" placeholder="Nh·∫≠p t√™n, m√£ v·∫≠t t∆∞...">
                </div>
                <button type="button" id="btnAddEmpty" class="btn btn-outline-secondary btn-sm">+ Th√™m d√≤ng tr·ªëng</button>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle" id="issueDetailsTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width:30%">S·∫£n ph·∫©m</th>
                      <th>Ghi ch√∫</th>
                      <th style="width:10%" class="text-end">SL</th>
                      <th style="width:12%" class="text-end">T·ªìn (kho ch·ªçn)</th>  @* th√™m *@
                      <th style="width:12%" class="text-end">Gi√° xu·∫•t</th>
                      <th style="width:10%">ƒêVT</th>
                      <th style="width:8%"></th>
                    </tr>
                  </thead>
                  <tbody id="issueDetailBody"></tbody>
                </table>
              </div>

              <div class="d-flex justify-content-end mt-2">
                <div class="text-end">
                  <div><strong>T·ªïng SL:</strong> <span id="sumItemsOut">0</span></div>
                  <div><strong>T·ªïng ti·ªÅn xu·∫•t:</strong> <span id="sumAmountOut">0 ƒë</span></div>
                </div>
              </div>

              <div class="text-muted small mt-1">* Enter trong √¥ t√¨m ki·∫øm ƒë·ªÉ th√™m d√≤ng nhanh</div>
              <div class="text-muted small">* T·ª± ch·∫∑n ch·ªçn tr√πng v·∫≠t t∆∞</div>

               <div class="modal-footer">
                <div class="me-auto text-danger" id="formErrorOut"></div>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="submit" class="btn btn-primary" id="btnSubmitOut">T·∫°o</button>
              </div>

            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  /* Action bar d√≠nh cu·ªëi c·ªôt ph·∫£i, kh√¥ng b·ªã CSS global ·∫©n */
  #siCreateModal .sticky-actions{
    position: sticky;
    bottom: 0;
    background: #fff;
    border-top: 1px solid #e9ecef;
    padding: .75rem;
    display: flex;
    gap: .5rem;
    justify-content: flex-end;
    z-index: 2;
  }
</style>

@* <script>
(function(){
  const modal = document.getElementById('siCreateModal') || document.getElementById('createIssueModal');
  if(!modal){ console.warn('Kh√¥ng t√¨m th·∫•y modal siCreateModal/createIssueModal'); return; }

  // DATA v·∫≠t t∆∞
  const mats = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    materials.Select(m => new { m.Id, m.Code, m.Name, m.Unit, m.Specification, m.PurchasePrice })
  ));

  // ====== C√ÅC GETTER KH·ªöP V·ªöI ID ·ªû HTML ======
  const tbody      = () => modal.querySelector('#issueDetailBody');
  const search     = () => modal.querySelector('#matSearchOut');
  const sumItemsEl = () => modal.querySelector('#sumItemsOut');
  const sumAmtEl   = () => modal.querySelector('#sumAmountOut');
  const whSel      = () => modal.querySelector('#WarehouseId');
  const submitBtn  = () => modal.querySelector('#btnSubmitOut');
  const errorBox   = () => modal.querySelector('#formErrorOut');

  let onhandCache = {}; // key: `${wid}:${matId}` -> number

  function uid(){ return (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'k'+Date.now()+Math.random().toString(16).slice(2); }

  function refreshOptionStates(){
    const selects = modal.querySelectorAll('.mat-select');
    const chosen  = new Set([...selects].map(s => s.value).filter(Boolean));
    selects.forEach(sel => {
      const keep = sel.value;
      [...sel.options].forEach(opt => {
        if(!opt.value) return;
        opt.disabled = (chosen.has(opt.value) && opt.value !== keep);
      });
    });
  }

  function notifyDup(){ alert('S·∫£n ph·∫©m n√†y ƒë√£ ƒë∆∞·ª£c ch·ªçn ·ªü d√≤ng kh√°c. Vui l√≤ng ch·ªçn s·∫£n ph·∫©m kh√°c.'); }

  function renderRow(prefill){
    const key = uid();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="hidden" name="Details.index" value="${key}" />
        <select name="Details[${key}].MaterialId" class="form-select form-select-sm mat-select">
          <option value="">-- Ch·ªçn --</option>
          ${mats.map(m => `<option value="${m.Id}">${(m.Code ?? '').trim()} ${m.Name}</option>`).join('')}
        </select>
      </td>
      <td><input name="Details[${key}].Specification" class="form-control form-control-sm" placeholder="Ghi ch√∫ d√≤ng"/></td>
      <td><input name="Details[${key}].Quantity" type="number" min="1" step="1" class="form-control form-control-sm text-end qty" value="${prefill?.q ?? 1}"/></td>
      <td class="text-end">
        <span class="onhand" data-onhand="0">‚Äî</span>
      </td>
      <td><input name="Details[${key}].UnitPrice" type="number" min="0" step="0.01" class="form-control form-control-sm text-end price" value="${prefill?.p ?? 0}"/></td>
      <td><input name="Details[${key}].Unit" class="form-control form-control-sm unit"/></td>
      <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm del">‚úï</button>
      </td>`;
    tbody().appendChild(tr);

    const sel = tr.querySelector('.mat-select');
    sel.addEventListener('change', (e)=>{
      const val = e.target.value;
      if(!val){ refreshOptionStates(); return; }
      const dup = [...modal.querySelectorAll('.mat-select')].some(s => s !== sel && s.value === val);
      if(dup){
        notifyDup();
        sel.value = "";
        tr.querySelector('.unit').value = '';
        tr.querySelector('.qty').value = 1;
        tr.querySelector('input[name$=".Specification"]').value = '';
        tr.querySelector('.price').value = '';
        refreshOptionStates();
        return;
      }
      const m = mats.find(x => String(x.Id) === String(val));
      tr.querySelector('.unit').value = m ? (m.Unit || '') : '';
      tr.querySelector('.qty').value = 1;
      tr.querySelector('input[name$=".Specification"]').value = m ? (m.Specification || '') : '';
      if(m && m.PurchasePrice != null) tr.querySelector('.price').value = m.PurchasePrice;
      refreshOptionStates();
      calc();
    });

    tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); refreshOptionStates(); calc(); });

    const qty = tr.querySelector('.qty');
    qty.addEventListener('input', ()=>{ qty.value = qty.value.replace(/[^\d]/g,''); calc(); });
    qty.addEventListener('blur', ()=>{ qty.value = Math.max(1, Math.floor(Number(qty.value||1))); calc(); });

    tr.querySelector('.price').addEventListener('input', calc);

    calc();
    refreshOptionStates();
  }

  function calc(){
    let items = 0, amount = 0;
    tbody().querySelectorAll('tr').forEach(tr=>{
      const q = Number(tr.querySelector('.qty')?.value || 0);
      const p = Number(tr.querySelector('.price')?.value || 0);
      if(q>0){ items += q; amount += q*p; }
    });
    if(sumItemsEl()) sumItemsEl().textContent = items.toLocaleString('vi-VN');
    if(sumAmtEl())   sumAmtEl().textContent   = amount.toLocaleString('vi-VN') + ' ƒë';
  }

  // Khi m·ªü modal
  modal.addEventListener('shown.bs.modal', ()=>{
    if(tbody()){ tbody().innerHTML = ''; renderRow(); }
    if(search()){ search().value=''; setTimeout(()=>search().focus(), 150); }
    refreshOptionStates();
  });

  // N√∫t "Th√™m d√≤ng tr·ªëng"
  modal.addEventListener('click', (e)=>{
    const btn = e.target.closest('#btnAddEmpty');
    if(!btn) return;
    e.preventDefault();
    renderRow();
  });

  // Enter trong √¥ t√¨m ki·∫øm -> th√™m d√≤ng
  document.addEventListener('keydown', (e)=>{
    if(search() && document.activeElement === search() && e.key === 'Enter'){
      e.preventDefault();
      renderRow();
    }
  });
})();
</script> *@
<script>
(function(){
  const modal = document.getElementById('siCreateModal');
  if(!modal) return;

  const baseOnHandUrl = '@Url.Action("OnHand","StockIssues")'; // ‚úÖ server render s·∫µn
  const mats = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    materials.Select(m => new { m.Id, m.Code, m.Name, m.Unit, m.Specification, m.SellingPrice })
  ));

  const tbody      = () => modal.querySelector('#issueDetailBody');
  const search     = () => modal.querySelector('#matSearchOut');
  const sumItemsEl = () => modal.querySelector('#sumItemsOut');
  const sumAmtEl   = () => modal.querySelector('#sumAmountOut');
  const whSel      = () => modal.querySelector('#WarehouseId');
  const submitBtn  = () => modal.querySelector('#btnSubmitOut');
  const errorBox   = () => modal.querySelector('#formErrorOut');

  let onhandCache = {}; // key: `${wid}:${matId}` -> number

  function uid(){ return (crypto?.randomUUID ? crypto.randomUUID() : 'k'+Date.now()+Math.random().toString(16).slice(2)); }

  function refreshOptionStates(){
    const selects = modal.querySelectorAll('.mat-select');
    const chosen  = new Set([...selects].map(s => s.value).filter(Boolean));
    selects.forEach(sel => {
      const keep = sel.value;
      [...sel.options].forEach(opt => {
        if(!opt.value) return;
        opt.disabled = (chosen.has(opt.value) && opt.value !== keep);
      });
    });
  }

  function renderRow(prefill){
    const key = uid();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="hidden" name="Details.index" value="${key}" />
        <select name="Details[${key}].MaterialId" class="form-select form-select-sm mat-select">
          <option value="">-- Ch·ªçn --</option>
          ${mats.map(m => `<option value="${m.Id}">${(m.Code ?? '').trim()} ${m.Name}</option>`).join('')}
        </select>
      </td>
      <td><input name="Details[${key}].Specification" class="form-control form-control-sm" placeholder="Ghi ch√∫ d√≤ng"/></td>
      <td><input name="Details[${key}].Quantity" type="number" min="1" step="1" class="form-control form-control-sm text-end qty" value="${prefill?.q ?? 1}"/></td>
      <td class="text-end"><span class="onhand" data-onhand="0">‚Äî</span></td>
      <td><input name="Details[${key}].UnitPrice" type="number" min="0" step="0.01" class="form-control form-control-sm text-end price" value="${prefill?.p ?? 0}"/></td>
      <td><input name="Details[${key}].Unit" class="form-control form-control-sm unit"/></td>
      <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm del">‚úï</button>
      </td>`;
    tbody().appendChild(tr);

    const sel  = tr.querySelector('.mat-select');
    const qtyI = tr.querySelector('.qty');
    const priceI = tr.querySelector('.price');


    sel.addEventListener('change', async (e)=>{
      const val = e.target.value;
      if(!val){ refreshOptionStates(); updateRowOnHand(tr); calc(); return; }

      // ch·∫∑n tr√πng
      const dup = [...modal.querySelectorAll('.mat-select')].some(s => s !== sel && s.value === val);
      if(dup){ alert('S·∫£n ph·∫©m ƒë√£ ch·ªçn ·ªü d√≤ng kh√°c.'); sel.value=''; refreshOptionStates(); updateRowOnHand(tr); calc(); return; }

      // fill nhanh
      const m = mats.find(x => String(x.Id) === String(val));
      tr.querySelector('.unit').value = m ? (m.Unit || '') : '';
      tr.querySelector('input[name$=".Specification"]').value = m ? (m.Specification || '') : '';
      if(m && m.SellingPrice != null) priceI.value = m.SellingPrice;


      refreshOptionStates();

      // n·∫°p t·ªìn theo kho ƒë√£ ch·ªçn
      await ensureOnHand([val]);
      updateRowOnHand(tr);
      validateRow(tr);
      calc();
    });

    qtyI.addEventListener('input', ()=>{ validateRow(tr); calc(); });
    priceI.addEventListener('input', calc);

    tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); refreshOptionStates(); calc(); });

    updateRowOnHand(tr);
    validateRow(tr);
    calc();
  }

  function getWarehouseId(){
    const v = whSel()?.value;
    return v ? parseInt(v,10) : 0;
  }

  async function ensureOnHand(materialIds){
    const wid = getWarehouseId();
    if(!wid || !materialIds?.length) return;

    const need = materialIds.filter(id => onhandCache[`${wid}:${id}`] == null);
    if(!need.length) return;

    try{
      // ‚úÖ build URL ƒë√∫ng
      const url = `${baseOnHandUrl}?warehouseId=${encodeURIComponent(wid)}&ids=${encodeURIComponent(need.join(','))}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      const data = await res.json();
      data.forEach(x => onhandCache[`${wid}:${x.materialId}`] = Number(x.qty) || 0);
      need.forEach(id => { const k = `${wid}:${id}`; if(onhandCache[k] == null) onhandCache[k] = 0; });
    }catch{ /* ignore */ }
  }

  function updateRowOnHand(tr){
    const wid = getWarehouseId();
    const sel = tr.querySelector('.mat-select');
    const ohSpan = tr.querySelector('.onhand');
    if(!ohSpan) return;

    const matId = sel?.value;
    if(!wid || !matId){
      ohSpan.dataset.onhand = '0';
      ohSpan.textContent = '‚Äî';
      return;
    }
    const key = `${wid}:${matId}`;
    const v = onhandCache[key];
    if(v == null) { ohSpan.dataset.onhand = '0'; ohSpan.textContent = '...'; }
    else { ohSpan.dataset.onhand = String(v); ohSpan.textContent = fmtQty(v); }
  }

  function validateRow(tr){
    const qtyI = tr.querySelector('.qty');
    const ohSpan = tr.querySelector('.onhand');
    qtyI.classList.remove('is-invalid');

    const q = Number(qtyI.value || 0);
    const onhand = Number(ohSpan?.dataset.onhand || 0);
    if(q > onhand) qtyI.classList.add('is-invalid');
  }

  function fmtQty(v){ return (v % 1 === 0) ? String(v|0) : v.toFixed(2).replace(/\.?0+$/,''); }

  function calc(){
    let items = 0, amount = 0, anyInvalid = false;
    tbody().querySelectorAll('tr').forEach(tr=>{
      const q = Number(tr.querySelector('.qty')?.value || 0);
      const p = Number(tr.querySelector('.price')?.value || 0);
      if(tr.querySelector('.qty')?.classList.contains('is-invalid')) anyInvalid = true;
      if(q>0){ items += q; amount += q*p; }
    });

    if(sumItemsEl()) sumItemsEl().textContent = items.toLocaleString('vi-VN');
    if(sumAmtEl())   sumAmtEl().textContent   = amount.toLocaleString('vi-VN') + ' ƒë';

    if(submitBtn()){
      submitBtn().disabled = anyInvalid || getWarehouseId() <= 0;
    }
    if(errorBox()){
      errorBox().textContent = (getWarehouseId() <= 0) ? 'Vui l√≤ng ch·ªçn kho tr∆∞·ªõc khi t·∫°o phi·∫øu.'
                                : anyInvalid ? 'C√≥ d√≤ng v∆∞·ª£t t·ªìn kho. Vui l√≤ng gi·∫£m s·ªë l∆∞·ª£ng.' : '';
    }
  }

  // ƒë·ªïi kho -> n·∫°p t·ªìn cho t·∫•t c·∫£ d√≤ng
  modal.addEventListener('change', async (e)=>{
    if(e.target && e.target.id === 'WarehouseId'){
      const ids = [...modal.querySelectorAll('.mat-select')].map(s => s.value).filter(Boolean);
      await ensureOnHand(ids);
      tbody().querySelectorAll('tr').forEach(tr => { updateRowOnHand(tr); validateRow(tr); });
      calc();
    }
  });

  // N√∫t th√™m d√≤ng (ƒë·ªìng b·ªô ID)
  modal.addEventListener('click', (e)=>{
    const btn = e.target.closest('#btnAddEmptyOut'); // ‚úÖ tr√πng v·ªõi id trong HTML
    if(!btn) return;
    e.preventDefault();
    renderRow();
  });

  // Enter trong √¥ t√¨m ki·∫øm
  document.addEventListener('keydown', (e)=>{
    if(search() && document.activeElement === search() && e.key === 'Enter'){
      e.preventDefault();
      renderRow();
    }
  });

  // Khi m·ªü modal -> reset
  modal.addEventListener('shown.bs.modal', ()=>{
    if(tbody()){ tbody().innerHTML = ''; renderRow(); }
    if(search()){ search().value=''; setTimeout(()=>search().focus(), 120); }
    onhandCache = {};
    calc();
  });
})();
</script>
