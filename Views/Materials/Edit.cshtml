@model MNBEMART.Models.Material
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Cập nhật nguyên liệu";

    // Phân biệt chế độ modal (ví dụ: /Materials/Edit/5?modal=1)
    bool asModal = false;
    if (Context?.Request?.Query.TryGetValue("modal", out var sv) == true)
    {
        asModal = sv.Count > 0 && string.Equals(sv[0], "1", StringComparison.OrdinalIgnoreCase);
    }

    var supplierList = ViewBag.SupplierId as SelectList;
    var warehouseList = ViewBag.WarehouseId as SelectList; // có thể null nếu bạn chưa dùng WarehouseId
}

<style>
  /* Phần card nổi gọn đẹp khi mở như trang riêng */
  .sheet-wrap {
    min-height: calc(100vh - 120px);
    display: grid; place-items: start center;
    padding: 24px 12px;
  }
  .sheet {
    width: min(980px, 96%);
    background: #fff; border-radius: 14px;
    box-shadow: 0 12px 40px rgba(0,0,0,.08), 0 1px 0 rgba(0,0,0,.03) inset;
    border: 1px solid #eee;
  }
  .sheet .sheet-header {
    padding: 14px 16px; border-bottom: 1px solid #f0f0f0;
    display:flex; align-items:center; gap:12px;
  }
  .sheet .sheet-body { padding: 16px; }
  .sheet .sheet-actions { padding: 12px 16px; border-top: 1px solid #f0f0f0; display:flex; justify-content:end; gap:8px; }

  .img-preview {
    width: 96px; height: 96px; object-fit: cover;
    border-radius: 8px; border: 1px solid #eee;
  }

  /* Nhỏ gọn inputs */
  .form-control-sm, .form-select-sm { font-size: .9rem; padding: .375rem .5rem; }
  .text-end { text-align: end; }
</style>

@if (asModal)
{
  <!-- Chế độ BẢNG NỔI (Bootstrap Modal) -->
  <div class="modal fade" id="materialEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="border-radius:14px;">
        <div class="modal-header">
          <h5 class="modal-title">Sửa nguyên liệu — @Model.Code</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          @* FORM *@
          @* <form asp-action="Edit" method="post" enctype="multipart/form-data" id="materialEditForm"> *@
          <form asp-action="Edit" asp-route-modal="1" method="post" enctype="multipart/form-data" id="materialEditForm">

            @Html.AntiForgeryToken()
            <div asp-validation-summary="All" class="text-danger mb-2"></div>
            <input type="hidden" asp-for="Id" />

            <div class="row g-3">
              <div class="col-6 col-md-3">
                <label class="form-label">Mã</label>
                <input asp-for="Code" class="form-control form-control-sm" />
                <span asp-validation-for="Code" class="text-danger"></span>
              </div>
              <div class="col-6 col-md-5">
                <label class="form-label">Tên</label>
                <input asp-for="Name" class="form-control form-control-sm" />
                <span asp-validation-for="Name" class="text-danger"></span>
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label">ĐVT</label>
                <input asp-for="Unit" class="form-control form-control-sm" />
                <span asp-validation-for="Unit" class="text-danger"></span>
              </div>
              @* <div class="col-6 col-md-2">
                <label class="form-label">Kho</label>
                <select asp-for="WarehouseId" asp-items="warehouseList" class="form-select form-select-sm">
                  <option value="hiden">-- Chọn --</option>
                </select>
              </div> *@

              <div class="col-12 col-md-6">
                <label class="form-label">Nhà cung cấp</label>
                <select asp-for="SupplierId" asp-items="supplierList" class="form-select form-select-sm">
                  <option value="">-- Chọn --</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Quy cách</label>
                <input asp-for="Specification" class="form-control form-control-sm" />
              </div>

              <div class="col-6 col-md-3">
                <label class="form-label">Giá nhập</label>
                <input asp-for="PurchasePrice" type="number" step="0.01" class="form-control form-control-sm text-end" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Giá bán</label>
                <input asp-for="SellingPrice" type="number" step="0.01" class="form-control form-control-sm text-end" />
              </div>

              <div class="col-12">
                <label class="form-label">Mô tả</label>
                <textarea asp-for="Description" rows="2" class="form-control form-control-sm"></textarea>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Ảnh mới</label>
                <input type="file" name="ImageFile" id="ImageFile" class="form-control form-control-sm" accept="image/*" />
                <div class="form-text">Chọn ảnh để thay thế (tuỳ chọn)</div>
              </div>
              <div class="col-12 col-md-6 d-flex align-items-end gap-2">
                <img id="imgPreview" src="@Model.ImageUrl" class="img-preview" alt="preview"/>
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                  <a href="@Model.ImageUrl" target="_blank" class="small">Xem ảnh hiện tại</a>
                }
              </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-3">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Đóng</button>
              <button type="submit" class="btn btn-primary btn-sm">Lưu</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
}
else
{
  <!-- Chế độ TRANG RIÊNG (card nổi ở giữa) -->
  <div class="sheet-wrap">
    <div class="sheet">
      <div class="sheet-header">
        <h5 class="mb-0">@ViewData["Title"]</h5>
        <span class="text-muted">— @Model.Code</span>
      </div>
      <div class="sheet-body">
        <form asp-action="Edit" method="post" enctype="multipart/form-data" id="materialEditForm">
          @Html.AntiForgeryToken()
          <div asp-validation-summary="All" class="text-danger mb-2"></div>
          <input type="hidden" asp-for="Id" />

          <div class="row g-3">
            <div class="col-6 col-md-3">
              <label class="form-label">Mã</label>
              <input asp-for="Code" class="form-control form-control-sm" />
              <span asp-validation-for="Code" class="text-danger"></span>
            </div>
            <div class="col-6 col-md-5">
              <label class="form-label">Tên</label>
              <input asp-for="Name" class="form-control form-control-sm" />
              <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label">ĐVT</label>
              <input asp-for="Unit" class="form-control form-control-sm" />
              <span asp-validation-for="Unit" class="text-danger"></span>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label">Kho</label>
              <select asp-for="WarehouseId" asp-items="warehouseList" class="form-select form-select-sm">
                <option value="">-- Chọn --</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Nhà cung cấp</label>
              <select asp-for="SupplierId" asp-items="supplierList" class="form-select form-select-sm">
                <option value="">-- Chọn --</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Quy cách</label>
              <input asp-for="Specification" class="form-control form-control-sm" />
            </div>

            <div class="col-6 col-md-3">
              <label class="form-label">Giá nhập</label>
              <input asp-for="PurchasePrice" type="number" step="0.01" class="form-control form-control-sm text-end" />
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Giá bán</label>
              <input asp-for="SellingPrice" type="number" step="0.01" class="form-control form-control-sm text-end" />
            </div>

            <div class="col-12">
              <label class="form-label">Mô tả</label>
              <textarea asp-for="Description" rows="2" class="form-control form-control-sm"></textarea>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Ảnh mới</label>
              <input type="file" name="ImageFile" id="ImageFile" class="form-control form-control-sm" accept="image/*" />
              <div class="form-text">Chọn ảnh để thay thế (tuỳ chọn)</div>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end gap-2">
              <img id="imgPreview" src="@Model.ImageUrl" class="img-preview" alt="preview"/>
              @if (!string.IsNullOrEmpty(Model.ImageUrl))
              {
                <a href="@Model.ImageUrl" target="_blank" class="small">Xem ảnh hiện tại</a>
              }
            </div>
          </div>

          <div class="sheet-actions">
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">Huỷ</a>
            <button type="submit" class="btn btn-primary btn-sm">Lưu</button>
          </div>
        </form>
      </div>
    </div>
  </div>
}

@section Scripts {
  <partial name="_ValidationScriptsPartial" />
  <script>
    // Preview ảnh khi chọn file
    document.addEventListener('change', function(e){
      if (e.target && e.target.id === 'ImageFile') {
        const file = e.target.files?.[0];
        if (!file) return;
        const img = document.getElementById('imgPreview');
        if (img) img.src = URL.createObjectURL(file);
      }
    });

    
  </script>
}
