@model MNBEMART.Models.MaterialIndexVM
@using System.Linq
@{
    Layout = null;
    var q = Model.Q ?? "";
    const int LowStockThreshold = 5;
    string FQty(decimal v) => (v % 1m == 0m) ? ((long)v).ToString() : v.ToString("0.##");
}

<!-- Tailwind + Bootstrap Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Success Message -->
@if (ViewBag.SuccessMessage != null)
{
    <div class="mb-6 px-4 py-3 bg-green-50 border border-green-200 rounded-xl text-green-700 text-sm flex items-center gap-2">
        <i class="bi bi-check-circle-fill"></i> @ViewBag.SuccessMessage
    </div>
}

<!-- Error Message -->
@if (ViewBag.ErrorMessage != null)
{
    <div class="mb-6 px-4 py-3 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 text-sm flex items-center gap-2">
        <i class="bi bi-exclamation-triangle-fill"></i> @ViewBag.ErrorMessage
    </div>
}

<!-- Mini Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <div class="bg-slate-50 border border-slate-200 rounded-md p-4">
        <p class="text-xs text-slate-500">Tổng bản ghi</p>
        <h4 class="text-lg font-semibold text-slate-800">@Model.TotalItems</h4>
    </div>
    <div class="bg-slate-50 border border-slate-200 rounded-md p-4">
        <p class="text-xs text-slate-500">Tổng SL tồn</p>
        <h4 class="text-lg font-semibold text-slate-800">@FQty(Model.TotalStockQty)</h4>
    </div>
    <div class="bg-slate-50 border border-slate-200 rounded-md p-4">
        <p class="text-xs text-slate-500">Giá trị tồn (theo giá nhập)</p>
        <h4 class="text-lg font-semibold text-slate-800">@Model.TotalStockValue.ToString("n0") đ</h4>
    </div>
</div>

<!-- Tag filters -->
@if (!string.IsNullOrWhiteSpace(q) || Model.WarehouseId.HasValue)
{
    <div class="flex flex-wrap gap-2 mb-4">
        @if (!string.IsNullOrWhiteSpace(q))
        { <span class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm">Từ khoá: <b>@q</b></span> }
        @if (Model.WarehouseId.HasValue)
        {
            var kw = Model.WarehouseOptions?.FirstOrDefault(o => o.Value == Model.WarehouseId.ToString())?.Text ?? "";
            <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-sm">Kho: <b>@kw</b></span>
        }
    </div>
}

<!-- Table -->
<div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-x-auto relative">
    <!-- Visual hint nếu cần scroll ngang -->
    <div class="absolute top-0 right-0 bg-blue-50 text-blue-600 text-xs px-2 py-1 rounded-bl z-10" style="display: none;" id="scrollHint">
        <i class="bi bi-arrow-left-right"></i> Kéo ngang để xem thêm
    </div>
    <table class="min-w-full text-sm text-slate-700">
        <thead class="bg-slate-100 text-slate-600 text-xs uppercase">
            <tr>
                <th class="px-3 py-2">Ảnh</th>
                <th class="px-3 py-2">Mã</th>
                <th class="px-3 py-2">Tên</th>
                <th class="px-3 py-2 text-center">ĐVT</th>
                <th class="px-3 py-2">Nhà cung cấp</th>
                <th class="px-3 py-2 text-end">Giá bán</th>
                <th class="px-3 py-2 text-center">Quy cách</th>
                <th class="px-3 py-2 text-center">Tồn</th>
                <th class="px-3 py-2 text-center" style="min-width: 140px;">Dự đoán nhu cầu</th>
                <th class="px-3 py-2">Kho</th>
                <th class="px-3 py-2 text-end">Thao tác</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
            @if (Model.Items != null && Model.Items.Any())
            {
                @foreach (var row in Model.Items)
                {
                    var m = row.M;
                    var qty = row.TotalQty;
                    string badgeColor = qty < 0 ? "bg-red-100 text-red-700"
                                        : qty == 0 ? "bg-slate-100 text-slate-600"
                                        : qty <= LowStockThreshold ? "bg-amber-100 text-amber-700"
                                        : "bg-emerald-100 text-emerald-700";
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-3 py-2">
                            @if (!string.IsNullOrEmpty(m.ImageUrl))
                            {
                                <img src="@m.ImageUrl" alt="@m.Name" class="w-10 h-10 rounded-md object-cover border border-slate-200" loading="lazy" width="40" height="40" />
                            }
                        </td>
                        <td class="px-3 py-2 font-semibold">@m.Code</td>
                        <td class="px-3 py-2">
                            <div class="font-medium text-slate-800">@m.Name</div>
                            @if (!string.IsNullOrWhiteSpace(m.Description))
                            { <div class="text-xs text-slate-500 line-clamp-2">@m.Description</div> }
                        </td>
                        <td class="px-3 py-2 text-center">@m.Unit</td>
                        <td class="px-3 py-2">@m.Supplier?.Name</td>
                        <td class="px-3 py-2 text-end">@((m.SellingPrice ?? 0m).ToString("n0")) đ</td>
                        <td class="px-3 py-2 text-center">@m.Specification</td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-medium @badgeColor">
                                @((qty % 1m == 0m) ? ((long)qty).ToString() : qty.ToString("0.##"))
                            </span>
                        </td>
                        <td class="px-3 py-2 text-center" style="min-width: 140px;">
                            @{
                                var warehouseId = row.WhereStock?.FirstOrDefault()?.WarehouseId ?? 0;
                            }
                            @if (warehouseId > 0)
                            {
                                <div class="forecast-cell" data-material-id="@m.Id" data-warehouse-id="@warehouseId" style="white-space: nowrap;">
                                    <button type="button" class="btn-forecast btn btn-sm btn-outline-info" title="Xem dự đoán nhu cầu">
                                        <i class="bi bi-graph-up"></i>
                                    </button>
                                    <div class="forecast-result d-none mt-1"></div>
                                </div>
                            }
                            else
                            {
                                <span class="text-xs text-slate-400">Chưa có kho</span>
                            }
                        </td>
                        <td class="px-3 py-2 space-x-1">
                            @if (row.WhereStock != null && row.WhereStock.Count > 0)
                            {
                                foreach (var w in row.WhereStock)
                                {
                                    <span class="inline-block px-2 py-0.5 text-xs rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                                        @w.WarehouseName <span class="text-slate-400">(@FQty(w.Qty))</span>
                                    </span>
                                }
                            }
                            else
                            {
                                <span class="inline-block px-2 py-0.5 text-xs rounded-full bg-slate-100 text-slate-500 border border-slate-200">
                                    Chưa phân kho
                                </span>
                            }
                        </td>
                        <td class="px-3 py-2 text-end">
                            <div class="flex justify-end gap-2">
                                <a href="#"
                                   data-url="@Url.Action("Edit","Materials", new { id = m.Id, modal = 1 })"
                                   class="js-edit px-2 py-1 text-xs rounded-md border border-blue-200 text-blue-600 hover:bg-blue-50">
                                    Sửa
                                </a>
                                <a href="#" data-id="@m.Id"
                                   class="px-2 py-1 text-xs rounded-md border border-red-200 text-red-600 hover:bg-red-50 material-delete-link">
                                    Xoá
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="11" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center justify-center">
                            <i class="bi bi-inbox text-4xl text-slate-300 mb-3"></i>
                            <p class="text-slate-500 font-medium">Chưa có nguyên liệu nào</p>
                            <p class="text-sm text-slate-400 mt-1">Hãy thêm nguyên liệu mới để bắt đầu</p>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@await Component.InvokeAsync("Pagination", new { 
    page = Model.Page, 
    totalPages = Model.TotalPages, 
    pageSize = Model.PageSize,
    actionName = "Index",
    routeValues = new { q = Model.Q, warehouseId = Model.WarehouseId }
})

