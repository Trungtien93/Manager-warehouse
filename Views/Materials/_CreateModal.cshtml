@model MNBEMART.Models.Material
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    var supplierItems = (SelectList)(ViewData["SupplierId"] ?? new SelectList(Enumerable.Empty<SelectListItem>()));
    var warehouseItems = (SelectList)(ViewData["WarehouseId"] ?? new SelectList(Enumerable.Empty<SelectListItem>()));
}

<div class="modal fade" id="materialCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thêm nguyên liệu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>

      <form asp-controller="Materials" asp-action="Create" method="post" enctype="multipart/form-data" id="materialForm">
        @Html.AntiForgeryToken()

        <div class="modal-body">
          <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

          <div class="row g-3">
            <div class="col-lg-8">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Mã nguyên liệu</label>
                  <input asp-for="Code" class="form-control" required />
                  <span asp-validation-for="Code" class="text-danger small"></span>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tên nguyên liệu</label>
                  <input asp-for="Name" class="form-control" required />
                  <span asp-validation-for="Name" class="text-danger small"></span>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Đơn vị</label>
                  <input asp-for="Unit" class="form-control" required />
                  <span asp-validation-for="Unit" class="text-danger small"></span>
                </div>
                <div class="col-md-8">
                  <label class="form-label">Quy cách</label>
                  <input asp-for="Specification" class="form-control" />
                  <span asp-validation-for="Specification" class="text-danger small"></span>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Giá nhập</label>
                  <input asp-for="PurchasePrice" type="number" step="0.01" min="0" class="form-control" required />
                  <span asp-validation-for="PurchasePrice" class="text-danger small"></span>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Giá bán</label>
                  <input asp-for="SellingPrice" type="number" step="0.01" min="0" class="form-control" required />
                  <span asp-validation-for="SellingPrice" class="text-danger small"></span>
                </div>

                <div class="col-12">
                  <label class="form-label">Mô tả</label>
                  <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                  <span asp-validation-for="Description" class="text-danger small"></span>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Nhà cung cấp</label>
                  <select asp-for="SupplierId" class="form-select" asp-items="supplierItems">
                    <option value="">-- Chọn --</option>
                  </select>
                  <span asp-validation-for="SupplierId" class="text-danger small"></span>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Kho</label>
                  <select asp-for="WarehouseId" class="form-select" asp-items="warehouseItems">
                    <option value="">-- Chưa phân kho --</option>
                  </select>
                  <span asp-validation-for="WarehouseId" class="text-danger small"></span>
                </div>
              </div>
            </div>

            <div class="col-lg-4">
              <label class="form-label">Ảnh nguyên liệu</label>
              <input type="file" name="ImageFile" accept="image/*" class="form-control" id="materialImageFile" />
              <div class="mt-2 text-center">
                <img id="materialImagePreview" src="#" alt="Preview" class="img-fluid rounded border d-none" />
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-primary">Lưu</button>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts{
  <partial name="_ValidationScriptsPartial" />
  <script>
    (function(){
      const file = document.getElementById('materialImageFile');
      const img  = document.getElementById('materialImagePreview');
      if (!file) return;
      file.addEventListener('change', () => {
        const f = file.files?.[0];
        if (!f) { img.classList.add('d-none'); img.src = '#'; return; }
        const fr = new FileReader();
        fr.onload = e => { img.src = e.target.result; img.classList.remove('d-none'); }
        fr.readAsDataURL(f);
      });
    })();
  </script>
}
