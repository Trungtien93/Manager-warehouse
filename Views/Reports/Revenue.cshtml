@model List<MNBEMART.ViewModels.RevenueRowVM>
@using System.Globalization
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Doanh thu xuất kho";
    dynamic f = ViewBag.Filter;
    DateTime displayFrom = (f?.From as DateTime?)?.Date ?? DateTime.Now.Date.AddDays(-7);
    DateTime displayTo   = (f?.To as DateTime?)?.Date   ?? DateTime.Now.Date;
    string groupBy = f?.GroupBy as string ?? "day";
    int? warehouseId = f?.WarehouseId as int?;
    decimal total = ViewBag.Total is decimal d ? d : Model.Sum(x => x.TotalRevenue);

    string TrimDec(decimal v, int maxDecimals = 2) {
        var fmt = "0." + new string('#', maxDecimals);
        return v.ToString(fmt, CultureInfo.InvariantCulture);
    }

    var groupByItems = new List<SelectListItem> {
        new("day","Ngày"){Selected=groupBy=="day"},
        new("month","Tháng"){Selected=groupBy=="month"},
        new("year","Năm"){Selected=groupBy=="year"}
    };
}

<!-- Tailwind + Chart.js -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<div class="min-h-screen bg-slate-50 p-6 md:p-8 space-y-6 text-slate-700">

    <!-- Tiêu đề -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="bi bi-graph-up text-blue-600"></i> Doanh thu xuất kho
            </h1>
            <p class="text-sm text-slate-500">Thống kê doanh thu theo ngày, tháng, hoặc năm</p>
        </div>
    </div>

    <!-- Form lọc -->
    <form method="get" asp-controller="Reports" asp-action="Revenue"
          class="bg-white border border-slate-200 shadow-sm rounded-xl p-5 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">

        <div>
            <label class="block text-sm font-medium text-slate-600 mb-1">Từ ngày</label>
            <input type="date" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"
                   name="From" value="@displayFrom:yyyy-MM-dd" />
        </div>

        <div>
            <label class="block text-sm font-medium text-slate-600 mb-1">Đến ngày</label>
            <input type="date" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"
                   name="To" value="@displayTo:yyyy-MM-dd" />
        </div>

        <div>
            <label class="block text-sm font-medium text-slate-600 mb-1">Kho</label>
            @Html.DropDownList("WarehouseId",
                (IEnumerable<SelectListItem>)ViewBag.Warehouses,
                htmlAttributes: new { @class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500" })
        </div>

        <div>
            <label class="block text-sm font-medium text-slate-600 mb-1">Nhóm theo</label>
            @Html.DropDownList("GroupBy",
                groupByItems,
                htmlAttributes: new { @class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500" })
        </div>

        <div class="flex items-end">
            <button class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm transition">
                <i class="bi bi-funnel me-1"></i> Xem
            </button>
        </div>
    </form>

    <!-- Biểu đồ -->
    <div class="bg-white border border-slate-200 shadow-sm rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                <i class="bi bi-bar-chart-line text-blue-600"></i> Biểu đồ doanh thu
            </h2>
            <span class="text-sm text-slate-500">Tổng: <b class="text-blue-600">@TrimDec(total)</b></span>
        </div>
        <canvas id="revChart" height="100"></canvas>
    </div>

    <!-- Bảng -->
    <div class="bg-white border border-slate-200 shadow-sm rounded-xl p-6">
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-slate-700">
                <thead class="bg-slate-100 text-slate-600 text-xs uppercase">
                    <tr>
                        <th class="px-3 py-2 text-left">Kỳ</th>
                        <th class="px-3 py-2 text-right">Doanh thu</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    @foreach (var r in Model)
                    {
                        <tr class="hover:bg-slate-50 transition">
                            <td class="px-3 py-2">@r.Period</td>
                            <td class="px-3 py-2 text-right font-medium">@TrimDec(r.TotalRevenue)</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="bg-slate-100 font-semibold">
                        <td class="px-3 py-2 text-right">Tổng</td>
                        <td class="px-3 py-2 text-right">@TrimDec(total)</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Chart script -->
<script>
const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.Period)));
const values = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.TotalRevenue)));
new Chart(document.getElementById('revChart'), {
  type: 'line',
  data: {
    labels,
    datasets: [{
      label: 'Doanh thu xuất kho',
      data: values,
      fill: true,
      borderColor: '#3b82f6',
      backgroundColor: 'rgba(59,130,246,0.15)',
      tension: 0.3,
      borderWidth: 2,
      pointRadius: 3,
      pointBackgroundColor: '#2563eb'
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: { beginAtZero: true, ticks: { color: '#64748b' } },
      x: { ticks: { color: '#64748b' } }
    },
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#1e293b',
        titleColor: '#fff',
        bodyColor: '#fff',
        padding: 10,
        cornerRadius: 8
      }
    }
  }
});
</script>
