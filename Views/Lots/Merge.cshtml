@model List<MNBEMART.Models.StockLot>
@{
    ViewData["Title"] = "Gộp lô hàng";
    var totalQuantity = Model.Sum(l => l.Quantity);
}

<div class="max-w-5xl mx-auto px-6 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-black text-slate-900 tracking-tight mb-2">
            <i class="bi bi-union text-purple-600 me-2"></i>
            Gộp lô hàng
        </h1>
        <p class="text-slate-600">Gộp @Model.Count lô thành một lô duy nhất</p>
    </div>

    <!-- Lots to Merge -->
    <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6 mb-6">
        <h3 class="text-lg font-bold text-purple-900 mb-4">Các lô sẽ gộp (@Model.Count)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @foreach (var lot in Model)
            {
                <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <p class="font-mono font-semibold text-purple-900">@lot.LotNumber</p>
                    <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                        <div>
                            <span class="text-slate-600">SL:</span>
                            <span class="font-bold text-slate-900">@lot.Quantity.ToString("N2")</span>
                        </div>
                        <div>
                            <span class="text-slate-600">HSD:</span>
                            <span class="text-slate-900">@(lot.ExpiryDate?.ToString("dd/MM/yyyy") ?? "-")</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Material Info -->
    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-6">
        <h3 class="text-lg font-bold text-blue-900 mb-3">Vật tư</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <label class="text-sm font-semibold text-blue-700">Mã</label>
                <p class="text-blue-900 font-mono">@Model.First().Material?.Code</p>
            </div>
            <div>
                <label class="text-sm font-semibold text-blue-700">Tên</label>
                <p class="text-blue-900">@Model.First().Material?.Name</p>
            </div>
            <div>
                <label class="text-sm font-semibold text-blue-700">Kho</label>
                <p class="text-blue-900">@Model.First().Warehouse?.Name</p>
            </div>
            <div>
                <label class="text-sm font-semibold text-blue-700">Tổng SL sau gộp</label>
                <p class="text-2xl font-black text-blue-900">@totalQuantity.ToString("N2")</p>
            </div>
        </div>
    </div>

    <!-- Warnings -->
    @{
        var expiryDates = Model.Where(l => l.ExpiryDate.HasValue).Select(l => l.ExpiryDate.Value).Distinct().ToList();
        var hasMultipleExpiry = expiryDates.Count > 1;
    }

    @if (hasMultipleExpiry)
    {
        <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-6 mb-6">
            <div class="flex items-start gap-3">
                <i class="bi bi-exclamation-triangle-fill text-amber-600 text-2xl"></i>
                <div>
                    <h3 class="text-lg font-bold text-amber-900">Cảnh báo: Nhiều ngày hết hạn khác nhau</h3>
                    <p class="text-sm text-amber-800 mt-1">
                        Các lô có ngày hết hạn khác nhau. Lô gộp sẽ sử dụng ngày hết hạn sớm nhất: 
                        <strong>@expiryDates.Min().ToString("dd/MM/yyyy")</strong>
                    </p>
                </div>
            </div>
        </div>
    }

    <!-- Merge Form -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
        <form asp-action="MergeConfirmed" method="post">
            <input type="hidden" name="lotIds" value="@string.Join(",", Model.Select(l => l.Id))" />

            <div class="mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-2">Ghi chú</label>
                <textarea name="notes" rows="3" 
                          class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                          placeholder="Lý do gộp lô..."></textarea>
            </div>

            <div class="flex gap-3">
                <button type="submit" 
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-3 rounded-lg transition">
                    <i class="bi bi-union me-1"></i> Xác nhận gộp
                </button>
                <a asp-action="Index" 
                   class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold px-6 py-3 rounded-lg transition text-center">
                    Hủy
                </a>
            </div>
        </form>
    </div>
</div>






















































