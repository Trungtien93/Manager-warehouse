@model MNBEMART.Models.StockReceipt
@using MNBEMART.Models
@{
    ViewData["Title"] = "Chi tiết phiếu nhập";
    decimal sumQty = Model.Details?.Sum(d => Convert.ToDecimal(d.Quantity)) ?? 0m;
    decimal sumAmt = Model.Details?.Sum(d => Convert.ToDecimal(d.Quantity) * d.UnitPrice) ?? 0m;
    string FQty(decimal v) => (v % 1m == 0m) ? ((long)v).ToString() : v.ToString("0.##");
}

<!-- Tailwind + Bootstrap Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

<div class="max-w-[1400px] mx-auto px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight mb-2">
                    <i class="bi bi-box-arrow-in-down text-blue-600 me-2"></i>
                    Phiếu nhập: @Model.ReceiptNumber
                </h1>
                <p class="text-slate-600">
                    Tạo lúc @Model.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm") • Người lập: @Model.CreatedBy?.FullName
                </p>
            </div>
            <div class="flex items-center gap-3">
                @if (Model.Status == DocumentStatus.Moi)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-amber-100 text-amber-800">Mới</span>
                }
                else if (Model.Status == DocumentStatus.DaXacNhan)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800">Đã xác nhận</span>
                }
                else if (Model.Status == DocumentStatus.DaNhapHang)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-800">Đã nhập hàng</span>
                }
                else if (Model.Status == DocumentStatus.DaHuy)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800">Đã huỷ</span>
                }
                <a asp-action="PrintOne" asp-route-id="@Model.Id" target="_blank" 
                   class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2.5 rounded-lg transition flex items-center gap-2">
                    <i class="bi bi-printer"></i> In phiếu
                </a>
                <a asp-action="Index" class="bg-slate-600 hover:bg-slate-700 text-white font-medium px-5 py-2.5 rounded-lg transition flex items-center gap-2">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Receipt Info -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Thông tin phiếu</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-semibold text-slate-600">Kho</label>
                        <p class="text-slate-900 font-semibold">@Model.Warehouse?.Name</p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-600">Người giao</label>
                        <p class="text-slate-900">@(string.IsNullOrWhiteSpace(Model.DeliveredByName) ? "-" : Model.DeliveredByName)</p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-600">Số chứng từ gốc</label>
                        <p class="text-slate-900">@(string.IsNullOrWhiteSpace(Model.ReferenceDocumentNumber) ? "-" : Model.ReferenceDocumentNumber)</p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-600">Ngày chứng từ gốc</label>
                        <p class="text-slate-900">@(Model.ReferenceDate?.ToString("dd/MM/yyyy") ?? "-")</p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-600">Ghi chú</label>
                        <p class="text-slate-900">@(string.IsNullOrWhiteSpace(Model.Note) ? "-" : Model.Note)</p>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(Model.AttachedDocuments))
                    {
                        <div>
                            <label class="text-sm font-semibold text-slate-600 mb-2 block">Hình ảnh minh chứng</label>
                            <a href="@Model.AttachedDocuments" target="_blank" title="Xem ảnh kích thước đầy đủ">
                                <img src="@Model.AttachedDocuments" alt="Evidence" class="rounded-lg border border-slate-200 max-w-full max-h-48 cursor-pointer hover:opacity-90 transition" />
                            </a>
                        </div>
                    }

                    @if (Model.ApprovedAt.HasValue)
                    {
                        <div class="border-t border-slate-200 pt-4">
                            <div class="text-sm">
                                <p class="font-semibold text-slate-900 mb-1">Đã duyệt</p>
                                <p class="text-slate-600">Bởi: @Model.ApprovedBy?.FullName</p>
                                <p class="text-slate-600">Lúc: @Model.ApprovedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                        </div>
                    }
                    
                    @if (User.IsInRole("Admin"))
                    {
                        <div class="border-t border-slate-200 pt-4 space-y-2">
                            @if (Model.Status == DocumentStatus.Moi)
                            {
                                <form asp-action="ApprovePost" method="post" onsubmit="return confirm('Xác nhận phiếu này?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                                        <i class="bi bi-check-circle"></i> Xác nhận
                                    </button>
                                </form>
                            }
                            @if (Model.Status == DocumentStatus.DaXacNhan)
                            {
                                <form asp-action="ReceivePost" method="post" onsubmit="return confirm('Nhập hàng vào kho?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <button class="w-full bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                                        <i class="bi bi-check2-circle"></i> Nhập hàng
                                    </button>
                                </form>
                            }
                            @if (Model.Status != DocumentStatus.DaHuy)
                            {
                                <form asp-action="RejectPost" method="post" onsubmit="return confirmReject(this);">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <input type="hidden" name="note" value="" />
                                    <button class="w-full bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                                        <i class="bi bi-x-circle"></i> Huỷ phiếu
                                    </button>
                                </form>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column: Material Details -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Danh sách vật tư</h3>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800">
                        @(Model.Details?.Count ?? 0) mặt hàng
                    </span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:32%">Mã / Tên vật tư</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:15%">Quy cách</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:10%">ĐVT</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-700 uppercase" style="width:18%">Lô / NSX / HSD</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-slate-700 uppercase" style="width:12%">Số lượng</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-slate-700 uppercase" style="width:13%">Đơn giá</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-slate-700 uppercase" style="width:13%">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            @foreach (var d in Model.Details ?? Enumerable.Empty<StockReceiptDetail>())
                            {
                                var q = Convert.ToDecimal(d.Quantity);
                                var line = q * d.UnitPrice;
                                <tr class="hover:bg-slate-50">
                                    <td class="px-4 py-3">
                                        <div class="text-sm font-semibold text-slate-900">@d.Material?.Code</div>
                                        <div class="text-xs text-slate-500">@d.Material?.Name</div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-slate-600">
                                        @(string.IsNullOrWhiteSpace(d.Specification) ? "-" : d.Specification)
                                    </td>
                                    <td class="px-4 py-3 text-sm text-slate-700">
                                        @(string.IsNullOrWhiteSpace(d.Unit) ? d.Material?.Unit : d.Unit)
                                    </td>
                                    <td class="px-4 py-3 text-sm text-slate-600">
                                        <div>@(string.IsNullOrWhiteSpace(d.LotNumber) ? "-" : d.LotNumber)</div>
                                        <div class="text-xs text-slate-400">
                                            @(d.ManufactureDate?.ToString("dd/MM/yyyy") ?? "")
                                            @if (d.ExpiryDate.HasValue) {<text> → @d.ExpiryDate?.ToString("dd/MM/yyyy")</text>}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-right text-sm font-semibold text-slate-900">
                                        @FQty(q)
                                    </td>
                                    <td class="px-4 py-3 text-right text-sm text-slate-700">
                                        @d.UnitPrice.ToString("n0")
                                    </td>
                                    <td class="px-4 py-3 text-right text-sm font-semibold text-slate-900">
                                        @line.ToString("n0")
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-right text-sm font-bold text-slate-900" colspan="4">Tổng cộng:</th>
                                <th class="px-4 py-3 text-right text-sm font-bold text-slate-900">@FQty(sumQty)</th>
                                <th class="px-4 py-3"></th>
                                <th class="px-4 py-3 text-right text-sm font-bold text-slate-900">@sumAmt.ToString("n0")</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmReject(form) {
        const reason = prompt("Lý do huỷ phiếu:", "");
        if (reason === null) return false;
        form.querySelector('input[name="note"]').value = reason || "";
        return true;
    }
</script>














































