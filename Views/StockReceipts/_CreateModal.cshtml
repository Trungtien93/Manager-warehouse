@model MNBEMART.Models.StockReceipt
@using MNBEMART.Models
@{
    var materials = (IEnumerable<MNBEMART.Models.Material>)(ViewBag.Materials ?? Enumerable.Empty<MNBEMART.Models.Material>());
}
<div class="modal fade" id="srCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-fullscreen-md-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tạo phiếu nhập</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>

      <!-- Chỉ 1 form -->
      <form asp-action="CreateReceipt" method="post" id="receiptForm" enctype="multipart/form-data">
        @Html.AntiForgeryToken()

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-lg-3">
              <div class="border rounded p-3 bg-light">
                <div class="mb-3">
                  <label class="form-label">Kho chứa hàng <span class="text-danger">*</span></label>
                  <select asp-for="WarehouseId" class="form-select" asp-items="ViewBag.WarehouseOptions" required>
                    <option value="">-- Chọn kho --</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Người giao <span class="text-danger">*</span></label>
                  <input asp-for="DeliveredByName" class="form-control" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ngày chứng từ <span class="text-danger">*</span></label>
                  <input asp-for="ReferenceDate" type="date" class="form-control" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Hình ảnh minh chứng <span class="text-danger">*</span></label>
                  <input type="file" id="evidence" name="EvidenceFile" class="form-control" accept="image/*" required />
                  <div class="mt-2">
                    <img id="evidencePreview" src="#" alt="Preview" style="max-width:100%;max-height:180px;display:none;border:1px solid #e9ecef;border-radius:.5rem" />
                  </div>
                  <div class="form-text">Ảnh bắt buộc. Hỗ trợ PNG/JPG, tối đa ~5MB.</div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ghi chú</label>
                  <textarea asp-for="Note" rows="3" class="form-control"></textarea>
                </div>
                <div class="small text-muted">Người lập: @User.Identity?.Name</div>
              </div>
            </div>

            <div class="col-lg-9">
              <div class="d-flex justify-content-end align-items-center mb-2">
                <button type="button" id="btnAddEmpty" class="btn btn-outline-secondary btn-sm">+ Thêm dòng trống</button>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle" id="detailsTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width:30%">Sản phẩm</th>
                      <th>Ghi chú</th>
                      <th style="width:10%" class="text-end">SL</th>
                      <th style="width:12%" class="text-end">Giá nhập</th>
                      <th style="width:10%">ĐVT</th>
                      <th style="width:20%">Lô/NSX<sup class="text-danger">*</sup>/HSD<sup class="text-danger">*</sup></th>
                      <th style="width:8%"></th>
                    </tr>
                  </thead>
                  <tbody id="detailBody"></tbody>
                </table>
              </div>

              <div class="d-flex justify-content-end mt-2">
                <div class="text-end">
                  <div><strong>SL sản phẩm:</strong> <span id="sumItems">0</span></div>
                  <div><strong>Tổng tiền nhập:</strong> <span id="sumAmount">0 đ</span></div>
                </div>
              </div>

              <div class="text-muted small">* Ctrl+V để dán nhiều dòng (Mã, SL, Giá nhập)</div>

              <!-- Footer dính LUÔN THẤY -->
              <div class="sticky-actions">
                <div class="me-auto text-danger" id="formError"></div>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-primary" id="btnSubmit">Tạo</button>
              </div>
              
            </div>
          </div>
        </div> <!-- /modal-body -->
      </form>
    </div>
  </div>
</div>

<style>
  /* Điều chỉnh kích thước modal hợp lý */
  #srCreateModal .modal-dialog {
    max-width: 95vw;
    max-height: 95vh;
    margin: 1rem auto;
  }
  
  #srCreateModal .modal-content {
    max-height: 95vh;
    display: flex;
    flex-direction: column;
  }
  
  #srCreateModal .modal-body {
    overflow-y: auto;
    padding: 1.25rem;
    flex: 1 1 auto;
  }
  
  /* Cải thiện spacing trong form */
  #srCreateModal .border.rounded {
    padding: 1rem !important;
  }
  
  #srCreateModal .form-label {
    margin-bottom: 0.5rem;
    font-weight: 500;
  }
  
  #srCreateModal .mb-3 {
    margin-bottom: 1rem !important;
  }
  
  /* Điều chỉnh table spacing và scroll khi có nhiều dòng */
  #srCreateModal .table-responsive {
    margin-bottom: 1rem;
    max-height: 450px;
    overflow-y: auto;
    overflow-x: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    position: relative;
  }
  
  /* Sticky header khi scroll */
  #srCreateModal .table-responsive .table thead {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
  }
  
  /* Hover effect cho table rows */
  #srCreateModal .table tbody tr {
    transition: background-color 0.15s ease-in-out;
  }
  
  #srCreateModal .table tbody tr:hover {
    background-color: #f8f9fa;
  }
  
  #srCreateModal .table {
    margin-bottom: 0.5rem;
  }
  
  /* Custom scrollbar styling */
  #srCreateModal .table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  #srCreateModal .table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  #srCreateModal .table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  #srCreateModal .table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  
  /* Firefox scrollbar */
  #srCreateModal .table-responsive {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
  }
  
  /* Action bar dính cuối cột phải, không bị CSS global ẩn */
  #srCreateModal .sticky-actions{
    position: sticky;
    bottom: 0;
    background: #fff;
    border-top: 1px solid #e9ecef;
    padding: .75rem;
    display: flex;
    gap: .5rem;
    justify-content: flex-end;
    z-index: 2;
    margin-top: 0.5rem;
  }
  
  /* Responsive cho màn hình nhỏ */
  @@media (max-width: 992px) {
    #srCreateModal .modal-dialog {
      max-width: 98vw;
      margin: 0.5rem auto;
    }
    
    #srCreateModal .modal-body {
      padding: 1rem;
    }
  }
</style>


<script>
(function(){
  try {
    console.log('[StockReceipts Modal] Initializing...');
    // LẤY MODAL: ưu tiên srCreateModal, fallback createReceiptModal
    const modal = document.getElementById('srCreateModal') || document.getElementById('createReceiptModal');
    if(!modal){ 
      console.warn('[StockReceipts Modal] Modal element not found');
      return; 
    }

    // DATA vật tư từ server
    const mats = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      materials.Select(m => new { m.Id, m.Code, m.Name, m.Unit, m.Specification, m.PurchasePrice })
    ));

    // GETTER nhanh - đảm bảo trả về giá trị an toàn
    const tbody      = () => {
      try { return modal?.querySelector('#detailBody') || null; } 
      catch(e) { console.error('[StockReceipts Modal] Error getting tbody:', e); return null; }
    };
    const sumItemsEl = () => {
      try { return modal?.querySelector('#sumItems') || null; } 
      catch(e) { console.error('[StockReceipts Modal] Error getting sumItemsEl:', e); return null; }
    };
    const sumAmtEl   = () => {
      try { return modal?.querySelector('#sumAmount') || null; } 
      catch(e) { console.error('[StockReceipts Modal] Error getting sumAmtEl:', e); return null; }
    };
    const fileInput = () => {
      try { return modal?.querySelector('#evidence') || null; } 
      catch(e) { console.error('[StockReceipts Modal] Error getting fileInput:', e); return null; }
    };
    const preview = () => {
      try { return modal?.querySelector('#evidencePreview') || null; } 
      catch(e) { console.error('[StockReceipts Modal] Error getting preview:', e); return null; }
    };
    const submitBtn = () => {
      try { return modal?.querySelector('#btnSubmit') || null; } 
      catch(e) { console.error('[StockReceipts Modal] Error getting submitBtn:', e); return null; }
    };
    const form = () => {
      try { return modal?.querySelector('#receiptForm') || null; } 
      catch(e) { console.error('[StockReceipts Modal] Error getting form:', e); return null; }
    };

    let isModalInitialized = false; // Flag để tránh validation quá sớm

  // Tạo key cho prefixer của MVC (Details[index].Field)
  function uid(){ return (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'k'+Date.now()+Math.random().toString(16).slice(2); }

  // Tự động tạo mã lô
  function generateLotNumber(){
    const now = new Date();
    const timestamp = now.getFullYear().toString() +
                      String(now.getMonth() + 1).padStart(2, '0') +
                      String(now.getDate()).padStart(2, '0') +
                      String(now.getHours()).padStart(2, '0') +
                      String(now.getMinutes()).padStart(2, '0') +
                      String(now.getSeconds()).padStart(2, '0');
    const random = Math.floor(Math.random() * 900) + 100; // 100-999
    return `LOT-${timestamp}-${random}`;
  }

  // Disable option đã chọn ở dòng khác
  function refreshOptionStates(){
    try {
      const selects = modal.querySelectorAll('.mat-select');
      const chosen  = new Set([...selects].map(s => s.value).filter(Boolean));
      selects.forEach(sel => {
        try {
          const keep = sel.value;
          [...sel.options].forEach(opt => {
            if(!opt.value) return;
            opt.disabled = (chosen.has(opt.value) && opt.value !== keep);
          });
        } catch (e) {
          console.warn('[StockReceipts Modal] Error in refreshOptionStates for select:', e);
        }
      });
    } catch (error) {
      console.error('[StockReceipts Modal] Error in refreshOptionStates:', error);
    }
  }

  function notifyDup(){
    alert('Sản phẩm này đã được chọn ở dòng khác. Vui lòng chọn sản phẩm khác.');
  }

  function renderRow(prefill){
    try {
      const tbodyEl = tbody();
      if (!tbodyEl) {
        console.warn('[StockReceipts Modal] tbody not found');
        return;
      }

      const key = uid();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <input type="hidden" name="Details.index" value="${key}" />
          <select name="Details[${key}].MaterialId" class="form-select form-select-sm mat-select" required>
            <option value="">-- Chọn --</option>
            ${mats.map(m => `<option value="${m.Id}">${(m.Code ?? '').trim()} ${m.Name}</option>`).join('')}
          </select>
        </td>
        <td><input name="Details[${key}].Specification" class="form-control form-control-sm" placeholder="Ghi chú dòng"/></td>
        <td><input name="Details[${key}].Quantity" type="number" min="1" step="1" class="form-control form-control-sm text-end qty" value="${prefill?.q ?? 1}" required/></td>
        <td><input name="Details[${key}].UnitPrice" type="number" min="0" step="0.01" class="form-control form-control-sm text-end price" value="${prefill?.p ?? 0}" readonly style="background-color: #e9ecef;" required/></td>
        <td><input name="Details[${key}].Unit" class="form-control form-control-sm unit" required/></td>
        <td>
          <input name="Details[${key}].LotNumber" class="form-control form-control-sm" placeholder="Mã lô" readonly style="background-color: #e9ecef;" value="${generateLotNumber()}"/>
          <small class="form-text text-muted">Tự động tạo</small>
          <div class="d-flex gap-1 mt-1">
            <input name="Details[${key}].ManufactureDate" type="date" class="form-control form-control-sm" title="Ngày sản xuất *" required/>
            <input name="Details[${key}].ExpiryDate" type="date" class="form-control form-control-sm" title="Hạn sử dụng *" required/>
          </div>
        </td>
        <td class="text-center">
          <button type="button" class="btn btn-outline-danger btn-sm del">✕</button>
        </td>`;
      tbodyEl.appendChild(tr);

    // Chọn vật tư
    const sel = tr.querySelector('.mat-select');
    sel.addEventListener('change', (e)=>{
      const val = e.target.value;
      if(!val){ refreshOptionStates(); validateForm(); return; }

      // Kiểm tra TRÙNG
      const dup = [...modal.querySelectorAll('.mat-select')].some(s => s !== sel && s.value === val);
      if(dup){
        notifyDup();
        sel.value = "";
        tr.querySelector('.unit').value = '';
        tr.querySelector('.qty').value = 1;
        tr.querySelector('input[name$=".Specification"]').value = '';
        tr.querySelector('.price').value = '';
        refreshOptionStates();
        validateForm();
        return;
      }

      // Fill dữ liệu nếu không trùng
      const m = mats.find(x => String(x.Id) === String(val));
      tr.querySelector('.unit').value = m ? (m.Unit || '') : '';
      tr.querySelector('.qty').value = 1;
      tr.querySelector('input[name$=".Specification"]').value = m ? (m.Specification || '') : '';
      if(m && m.PurchasePrice != null) tr.querySelector('.price').value = m.PurchasePrice;
      refreshOptionStates();
      calc();
      // Chỉ validate nếu modal đã được khởi tạo
      if (isModalInitialized) {
        validateForm();
      }
    });

    // Xoá dòng
    tr.querySelector('.del').addEventListener('click', ()=>{
      tr.remove();
      refreshOptionStates();
      calc();
    });

      // Số lượng nguyên dương
      const qty = tr.querySelector('.qty');
      qty.addEventListener('input', ()=>{ 
        qty.value = qty.value.replace(/[^\d]/g,''); 
        calc(); 
        if (isModalInitialized) validateForm(); 
      });
      qty.addEventListener('blur', ()=>{ 
        qty.value = Math.max(1, Math.floor(Number(qty.value||1))); 
        calc(); 
        if (isModalInitialized) validateForm(); 
      });

      // Giá nhập là readonly, không cần event listener cho input
      // tr.querySelector('.price').addEventListener('input', ()=>{ calc(); validateForm(); });
      tr.querySelector('.unit')?.addEventListener('input', () => {
        if (isModalInitialized) validateForm();
      });
      
      // Validate khi thay đổi ngày sản xuất và hạn sử dụng
      tr.querySelector('input[name$=".ManufactureDate"]')?.addEventListener('change', () => {
        if (isModalInitialized) validateForm();
      });
      tr.querySelector('input[name$=".ExpiryDate"]')?.addEventListener('change', () => {
        if (isModalInitialized) validateForm();
      });

      calc();
      refreshOptionStates();
    } catch (error) {
      console.error('[StockReceipts Modal] Error in renderRow:', error);
    }
  }

  function calc(){
    try {
      let items = 0, amount = 0;
      const tbodyEl = tbody();
      if (!tbodyEl) return;
      
      tbodyEl.querySelectorAll('tr').forEach(tr=>{
        const q = Number(tr.querySelector('.qty')?.value || 0);
        const p = Number(tr.querySelector('.price')?.value || 0);
        if(q>0){ items += q; amount += q*p; }
      });
      if(sumItemsEl()) sumItemsEl().textContent = items.toLocaleString('vi-VN');
      if(sumAmtEl())   sumAmtEl().textContent   = amount.toLocaleString('vi-VN') + ' đ';
      
      // Chỉ validate nếu modal đã được khởi tạo
      if (isModalInitialized) {
        validateForm();
      }
    } catch (error) {
      console.error('[StockReceipts Modal] Error in calc:', error);
    }
  }

  function validateForm(){
    try {
      // Không validate nếu modal chưa được khởi tạo đầy đủ
      if (!isModalInitialized) {
        return true;
      }

      const formEl = form();
      const errorBox = modal.querySelector('#formError');
      const submitBtnEl = submitBtn();
      if(!formEl || !errorBox) return true;

    // Kiểm tra các trường bắt buộc ở form chính
    const warehouseId = formEl.querySelector('#WarehouseId')?.value;
    const deliveredByName = formEl.querySelector('#DeliveredByName')?.value?.trim();
    const referenceDate = formEl.querySelector('#ReferenceDate')?.value;
    const evidenceFileEl = fileInput();
    const evidenceFile = evidenceFileEl?.files?.[0];

    // Kiểm tra các dòng sản phẩm
    const rows = tbody().querySelectorAll('tr');
    let hasValidRow = false;
    let rowErrors = [];

    rows.forEach((tr, index) => {
      const materialId = tr.querySelector('.mat-select')?.value;
      const qty = tr.querySelector('.qty')?.value;
      const price = tr.querySelector('.price')?.value;
      const unit = tr.querySelector('.unit')?.value?.trim();
      const mfgDate = tr.querySelector('input[name$=".ManufactureDate"]')?.value;
      const expDate = tr.querySelector('input[name$=".ExpiryDate"]')?.value;

      if(materialId && qty && price && unit && mfgDate && expDate){
        hasValidRow = true;
      } else if(materialId || qty || price || unit || mfgDate || expDate){
        // Có một phần dữ liệu nhưng chưa đủ
        const missingFields = [];
        if(!materialId) missingFields.push('Sản phẩm');
        if(!qty) missingFields.push('SL');
        if(!price) missingFields.push('Giá nhập');
        if(!unit) missingFields.push('ĐVT');
        if(!mfgDate) missingFields.push('Ngày sản xuất');
        if(!expDate) missingFields.push('Hạn sử dụng');
        rowErrors.push(`Dòng ${index + 1}: Vui lòng điền đầy đủ thông tin (${missingFields.join(', ')}).`);
      }
    });

    let errors = [];
    if(!warehouseId) errors.push('Vui lòng chọn kho chứa hàng.');
    if(!deliveredByName) errors.push('Vui lòng nhập người giao.');
    if(!referenceDate) errors.push('Vui lòng chọn ngày chứng từ.');
    if(!evidenceFile) errors.push('Vui lòng chọn hình ảnh minh chứng.');
    if(!hasValidRow) errors.push('Vui lòng nhập ít nhất 1 dòng sản phẩm với đầy đủ thông tin (Sản phẩm, SL, Giá nhập, ĐVT, Ngày sản xuất, Hạn sử dụng).');
    if(rowErrors.length > 0) errors.push(...rowErrors);

    if(errors.length > 0){
      errorBox.textContent = errors[0];
      errorBox.style.display = 'block';
      if(submitBtnEl) submitBtnEl.disabled = true;
      return false;
    } else {
      errorBox.textContent = '';
      errorBox.style.display = 'none';
      if(submitBtnEl) submitBtnEl.disabled = false;
      return true;
    }
    } catch (error) {
      console.error('[StockReceipts Modal] Error in validateForm:', error);
      return true; // Trả về true để không block form submission nếu có lỗi
    }
  }

  // Preview ảnh minh chứng + bắt buộc
  function resetPreview(){ 
    try {
      const previewEl = preview();
      if(previewEl){ 
        previewEl.src='#'; 
        previewEl.style.display='none'; 
      }
    } catch (e) {
      console.warn('[StockReceipts Modal] Error in resetPreview:', e);
    }
  }
  
  const fileInputEl = fileInput();
  if (fileInputEl) {
    fileInputEl.addEventListener('change', () => {
      try {
        const f = fileInputEl.files?.[0];
        if(!f){ resetPreview(); if (isModalInitialized) validateForm(); return; }
        if(!f.type.startsWith('image/')){ alert('Chỉ chấp nhận hình ảnh.'); fileInputEl.value=''; resetPreview(); if (isModalInitialized) validateForm(); return; }
        if(f.size > 5*1024*1024){ alert('Ảnh quá lớn (>5MB).'); fileInputEl.value=''; resetPreview(); if (isModalInitialized) validateForm(); return; }
        const url = URL.createObjectURL(f); 
        const previewEl = preview();
        if(previewEl){ 
          previewEl.src = url; 
          previewEl.style.display='block'; 
        }
        if (isModalInitialized) validateForm();
      } catch (error) {
        console.error('[StockReceipts Modal] Error in fileInput change:', error);
      }
    });
  }

  // Validate khi các trường thay đổi
  const formEl = form();
  if (formEl) {
    formEl.addEventListener('change', (e) => {
      try {
        if(e.target.id === 'WarehouseId' || e.target.id === 'DeliveredByName' || e.target.id === 'ReferenceDate'){
          if (isModalInitialized) validateForm();
        }
      } catch (error) {
        console.error('[StockReceipts Modal] Error in form change:', error);
      }
    });

    formEl.addEventListener('input', (e) => {
      try {
        if(e.target.id === 'DeliveredByName'){
          if (isModalInitialized) validateForm();
        }
      } catch (error) {
        console.error('[StockReceipts Modal] Error in form input:', error);
      }
    });

    // Validate trước khi submit
    formEl.addEventListener('submit', (e) => {
      try {
        if(!validateForm()){
          e.preventDefault();
          return false;
        }
      } catch (error) {
        console.error('[StockReceipts Modal] Error in form submit:', error);
        e.preventDefault();
        return false;
      }
    });
  }

  // MỞ MODAL → reset & thêm 1 dòng
  modal.addEventListener('show.bs.modal', (e)=>{
    console.log('[StockReceipts Modal] show.bs.modal event fired');
  });

  // Ngăn modal tự đóng khi có lỗi hoặc trong 500ms đầu
  let preventAutoClose = false;
  let modalOpenTime = 0;
  
  modal.addEventListener('hide.bs.modal', function(e) {
    const timeSinceOpen = Date.now() - modalOpenTime;
    
    // Ngăn đóng trong 500ms đầu hoặc khi có flag preventAutoClose
    if (preventAutoClose || timeSinceOpen < 500) {
      console.warn('[StockReceipts Modal] Preventing auto-close - timeSinceOpen:', timeSinceOpen, 'ms, preventAutoClose:', preventAutoClose);
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      if (preventAutoClose) {
        preventAutoClose = false; // Reset sau khi prevent
      }
      return false;
    }
  });

  // MỞ MODAL → reset & thêm 1 dòng
  modal.addEventListener('show.bs.modal', (e)=>{
    console.log('[StockReceipts Modal] show.bs.modal event fired');
    preventAutoClose = false; // Reset flag
    modalOpenTime = Date.now(); // Ghi lại thời gian mở modal
    
    // Đảm bảo config ngăn đóng
    try {
      const bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) {
        bsModal._config.backdrop = 'static';
        bsModal._config.keyboard = false;
      }
    } catch (err) {
      console.warn('[StockReceipts Modal] Error setting modal config:', err);
    }
  });

  modal.addEventListener('shown.bs.modal', ()=>{
    console.log('[StockReceipts Modal] shown.bs.modal event fired');
    try {
      isModalInitialized = false; // Reset flag
      preventAutoClose = true; // Bật flag để ngăn auto-close
      
      // Delay để đảm bảo DOM đã hoàn toàn sẵn sàng trước khi thao tác
      setTimeout(() => {
        try {
          const tbodyEl = tbody();
          if (tbodyEl) {
            tbodyEl.innerHTML = '';
            // Delay thêm một chút trước khi render row để đảm bảo DOM đã ổn định
            setTimeout(() => {
              try {
                renderRow();
              } catch (error) {
                console.error('[StockReceipts Modal] Error in renderRow:', error);
                preventAutoClose = false; // Cho phép đóng nếu có lỗi nghiêm trọng
              }
            }, 100);
          }
          
          try {
            resetPreview();
            refreshOptionStates();
          } catch (error) {
            console.error('[StockReceipts Modal] Error in resetPreview/refreshOptionStates:', error);
          }
          
          // Delay để đảm bảo DOM đã render xong trước khi tính toán và validate
          setTimeout(() => {
            try {
              calc();
              isModalInitialized = true; // Đánh dấu modal đã sẵn sàng
              preventAutoClose = false; // Tắt flag sau khi mọi thứ đã ổn định
              
              // Gọi validateForm với delay nhỏ hơn nữa để đảm bảo mọi thứ đã sẵn sàng
              setTimeout(() => {
                try {
                  validateForm();
                } catch (error) {
                  console.error('[StockReceipts Modal] Error in validateForm:', error);
                }
              }, 50);
            } catch (error) {
              console.error('[StockReceipts Modal] Error in shown.bs.modal setTimeout:', error);
              preventAutoClose = false; // Cho phép đóng nếu có lỗi
            }
          }, 200);
        } catch (error) {
          console.error('[StockReceipts Modal] Error in shown.bs.modal setTimeout:', error);
          preventAutoClose = false; // Cho phép đóng nếu có lỗi nghiêm trọng
        }
      }, 100); // Delay ban đầu để đảm bảo modal đã hoàn toàn hiển thị
      
    } catch (error) {
      console.error('[StockReceipts Modal] Error in shown.bs.modal:', error);
      preventAutoClose = false; // Cho phép đóng nếu có lỗi nghiêm trọng
    }
  });

  // NÚT "Thêm dòng trống"
  modal.addEventListener('click', (e)=>{
    const btn = e.target.closest('#btnAddEmpty');
    if(!btn) return;
    e.preventDefault();
    renderRow();
  });

  console.log('[StockReceipts Modal] Initialization complete');
  } catch (error) {
    console.error('[StockReceipts Modal] Fatal error during initialization:', error);
  }
})();
</script>
