@model MNBEMART.Models.StockReceipt
@using MNBEMART.Models
@{
    var materials = (IEnumerable<MNBEMART.Models.Material>)(ViewBag.Materials ?? Enumerable.Empty<MNBEMART.Models.Material>());
}
<div class="modal fade" id="srCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-fullscreen-md-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">T·∫°o phi·∫øu nh·∫≠p</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
      </div>

      <!-- Ch·ªâ 1 form -->
      <form asp-action="CreateReceipt" method="post" id="receiptForm">
        @Html.AntiForgeryToken()

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-lg-3">
              <div class="border rounded p-3 bg-light">
                <div class="mb-3">
                  <label class="form-label">Kho ch·ª©a h√†ng</label>
                  <select asp-for="WarehouseId" class="form-select" asp-items="ViewBag.WarehouseOptions">
                    <option value="">-- Ch·ªçn kho --</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ng∆∞·ªùi giao</label>
                  <input asp-for="DeliveredByName" class="form-control"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">S·ªë ch·ª©ng t·ª´ g·ªëc</label>
                  <input asp-for="ReferenceDocumentNumber" class="form-control"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ng√†y ch·ª©ng t·ª´</label>
                  <input asp-for="ReferenceDate" type="date" class="form-control"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ghi ch√∫</label>
                  <textarea asp-for="Note" rows="3" class="form-control"></textarea>
                </div>
                <div class="small text-muted">Ng∆∞·ªùi l·∫≠p: @User.Identity?.Name</div>
              </div>
            </div>

            <div class="col-lg-9">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group input-group-sm" style="max-width:520px">
                  <span class="input-group-text">üîç</span>
                  <input id="matSearch" class="form-control" placeholder="Nh·∫≠p t√™n, m√£ v·∫≠t t∆∞...">
                </div>
                <button type="button" id="btnAddEmpty" class="btn btn-outline-secondary btn-sm">+ Th√™m d√≤ng tr·ªëng</button>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle" id="detailsTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width:30%">S·∫£n ph·∫©m</th>
                      <th>Ghi ch√∫</th>
                      <th style="width:10%" class="text-end">SL</th>
                      <th style="width:12%" class="text-end">Gi√° nh·∫≠p</th>
                      <th style="width:10%">ƒêVT</th>
                      <th style="width:8%"></th>
                    </tr>
                  </thead>
                  <tbody id="detailBody"></tbody>
                </table>
              </div>

              <div class="d-flex justify-content-end mt-2">
                <div class="text-end">
                  <div><strong>SL s·∫£n ph·∫©m:</strong> <span id="sumItems">0</span></div>
                  <div><strong>T·ªïng ti·ªÅn nh·∫≠p:</strong> <span id="sumAmount">0 ƒë</span></div>
                </div>
              </div>

              <div class="text-muted small mt-1">* Enter trong √¥ t√¨m ki·∫øm ƒë·ªÉ th√™m d√≤ng nhanh</div>
              <div class="text-muted small">* Ctrl+V ƒë·ªÉ d√°n nhi·ªÅu d√≤ng (M√£, SL, Gi√° nh·∫≠p)</div>

              <!-- Footer d√≠nh LU√îN TH·∫§Y -->
              <div class="sticky-actions">
                <div class="me-auto text-danger" id="formError"></div>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="submit" class="btn btn-primary" id="btnSubmit">T·∫°o</button>
              </div>
              
            </div>
          </div>
        </div> <!-- /modal-body -->
      </form>
    </div>
  </div>
</div>

<style>
  /* Action bar d√≠nh cu·ªëi c·ªôt ph·∫£i, kh√¥ng b·ªã CSS global ·∫©n */
  #srCreateModal .sticky-actions{
    position: sticky;
    bottom: 0;
    background: #fff;
    border-top: 1px solid #e9ecef;
    padding: .75rem;
    display: flex;
    gap: .5rem;
    justify-content: flex-end;
    z-index: 2;
  }
</style>


<script>
(function(){
  // L·∫§Y MODAL: ∆∞u ti√™n srCreateModal, fallback createReceiptModal
  const modal = document.getElementById('srCreateModal') || document.getElementById('createReceiptModal');
  if(!modal){ console.warn('Kh√¥ng t√¨m th·∫•y modal srCreateModal/createReceiptModal'); return; }

  // DATA v·∫≠t t∆∞ t·ª´ server
  const mats = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    materials.Select(m => new { m.Id, m.Code, m.Name, m.Unit, m.Specification, m.PurchasePrice })
  ));

  // GETTER nhanh
  const tbody      = () => modal.querySelector('#detailBody');
  const search     = () => modal.querySelector('#matSearch');
  const sumItemsEl = () => modal.querySelector('#sumItems');
  const sumAmtEl   = () => modal.querySelector('#sumAmount');

  // T·∫°o key cho prefixer c·ªßa MVC (Details[index].Field)
  function uid(){ return (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'k'+Date.now()+Math.random().toString(16).slice(2); }

  // Disable option ƒë√£ ch·ªçn ·ªü d√≤ng kh√°c
  function refreshOptionStates(){
    const selects = modal.querySelectorAll('.mat-select');
    const chosen  = new Set([...selects].map(s => s.value).filter(Boolean));
    selects.forEach(sel => {
      const keep = sel.value;
      [...sel.options].forEach(opt => {
        if(!opt.value) return;
        opt.disabled = (chosen.has(opt.value) && opt.value !== keep);
      });
    });
  }

  function notifyDup(){
    alert('S·∫£n ph·∫©m n√†y ƒë√£ ƒë∆∞·ª£c ch·ªçn ·ªü d√≤ng kh√°c. Vui l√≤ng ch·ªçn s·∫£n ph·∫©m kh√°c.');
  }

  function renderRow(prefill){
    const key = uid();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="hidden" name="Details.index" value="${key}" />
        <select name="Details[${key}].MaterialId" class="form-select form-select-sm mat-select">
          <option value="">-- Ch·ªçn --</option>
          ${mats.map(m => `<option value="${m.Id}">${(m.Code ?? '').trim()} ${m.Name}</option>`).join('')}
        </select>
      </td>
      <td><input name="Details[${key}].Specification" class="form-control form-control-sm" placeholder="Ghi ch√∫ d√≤ng"/></td>
      <td><input name="Details[${key}].Quantity" type="number" min="1" step="1" class="form-control form-control-sm text-end qty" value="${prefill?.q ?? 1}"/></td>
      <td><input name="Details[${key}].UnitPrice" type="number" min="0" step="0.01" class="form-control form-control-sm text-end price" value="${prefill?.p ?? 0}"/></td>
      <td><input name="Details[${key}].Unit" class="form-control form-control-sm unit"/></td>
      <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm del">‚úï</button>
      </td>`;
    tbody().appendChild(tr);

    // Ch·ªçn v·∫≠t t∆∞
    const sel = tr.querySelector('.mat-select');
    sel.addEventListener('change', (e)=>{
      const val = e.target.value;
      if(!val){ refreshOptionStates(); return; }

      // Ki·ªÉm tra TR√ôNG
      const dup = [...modal.querySelectorAll('.mat-select')].some(s => s !== sel && s.value === val);
      if(dup){
        notifyDup();
        sel.value = "";
        tr.querySelector('.unit').value = '';
        tr.querySelector('.qty').value = 1;
        tr.querySelector('input[name$=".Specification"]').value = '';
        tr.querySelector('.price').value = '';
        refreshOptionStates();
        return;
      }

      // Fill d·ªØ li·ªáu n·∫øu kh√¥ng tr√πng
      const m = mats.find(x => String(x.Id) === String(val));
      tr.querySelector('.unit').value = m ? (m.Unit || '') : '';
      tr.querySelector('.qty').value = 1;
      tr.querySelector('input[name$=".Specification"]').value = m ? (m.Specification || '') : '';
      if(m && m.PurchasePrice != null) tr.querySelector('.price').value = m.PurchasePrice;
      refreshOptionStates();
      calc();
    });

    // Xo√° d√≤ng
    tr.querySelector('.del').addEventListener('click', ()=>{
      tr.remove();
      refreshOptionStates();
      calc();
    });

    // S·ªë l∆∞·ª£ng nguy√™n d∆∞∆°ng
    const qty = tr.querySelector('.qty');
    qty.addEventListener('input', ()=>{ qty.value = qty.value.replace(/[^\d]/g,''); calc(); });
    qty.addEventListener('blur', ()=>{ qty.value = Math.max(1, Math.floor(Number(qty.value||1))); calc(); });

    tr.querySelector('.price').addEventListener('input', calc);

    calc();
    refreshOptionStates();
  }

  function calc(){
    let items = 0, amount = 0;
    tbody().querySelectorAll('tr').forEach(tr=>{
      const q = Number(tr.querySelector('.qty')?.value || 0);
      const p = Number(tr.querySelector('.price')?.value || 0);
      if(q>0){ items += q; amount += q*p; }
    });
    if(sumItemsEl()) sumItemsEl().textContent = items.toLocaleString('vi-VN');
    if(sumAmtEl())   sumAmtEl().textContent   = amount.toLocaleString('vi-VN') + ' ƒë';
  }

  // M·ªû MODAL ‚Üí reset & th√™m 1 d√≤ng
  modal.addEventListener('shown.bs.modal', ()=>{
    if(tbody()){ tbody().innerHTML = ''; renderRow(); }
    if(search()){ search().value=''; setTimeout(()=>search().focus(), 150); }
    refreshOptionStates();
  });

  // N√öT "Th√™m d√≤ng tr·ªëng"
  modal.addEventListener('click', (e)=>{
    const btn = e.target.closest('#btnAddEmpty');
    if(!btn) return;
    e.preventDefault();
    renderRow();
  });

  // ENTER trong √¥ t√¨m ki·∫øm ‚Üí th√™m d√≤ng
  document.addEventListener('keydown', (e)=>{
    if(search() && document.activeElement === search() && e.key === 'Enter'){
      e.preventDefault();
      renderRow();
    }
  });
})();
</script>
