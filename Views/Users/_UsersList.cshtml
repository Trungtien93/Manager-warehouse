@model IEnumerable<MNBEMART.Models.User>
@{
    Layout = null;
    var i = 1;
    var status = ViewBag.Status as string ?? "all";
}

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<div class="min-h-screen bg-slate-50 p-6 md:p-8 space-y-6 text-slate-700">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="bi bi-people text-blue-600"></i> Quản lý người dùng
            </h1>
            <p class="text-sm text-slate-500">Theo dõi, phân quyền và quản lý tài khoản đăng nhập hệ thống</p>
        </div>

        <button type="button" data-bs-toggle="modal" data-bs-target="#createUserModal"
           class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition">
            <i class="bi bi-plus-circle"></i> Thêm người dùng
        </button>
    </div>

    @if (ViewBag.SuccessMessage != null)
    {
        <div class="bg-green-50 border border-green-200 text-green-700 rounded-lg px-4 py-3 mb-4 flex items-center gap-2">
            <i class="bi bi-check-circle-fill"></i>
            <span>@ViewBag.SuccessMessage</span>
        </div>
    }

    <!-- Status Tabs -->
    <div class="bg-white border border-slate-200 rounded-lg p-1 flex gap-1">
        <button type="button" data-status="all" 
           class="status-tab-btn @(status == "all" ? "bg-blue-600 text-white" : "text-slate-600 hover:bg-slate-100") flex-1 text-center py-2 px-4 rounded-md text-sm font-medium transition">
            Tất cả
        </button>
        <button type="button" data-status="pending" 
           class="status-tab-btn @(status == "pending" ? "bg-blue-600 text-white" : "text-slate-600 hover:bg-slate-100") flex-1 text-center py-2 px-4 rounded-md text-sm font-medium transition relative">
            Chờ duyệt
            @if (ViewBag.PendingCount > 0)
            {
                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">@ViewBag.PendingCount</span>
            }
        </button>
        <button type="button" data-status="active" 
           class="status-tab-btn @(status == "active" ? "bg-blue-600 text-white" : "text-slate-600 hover:bg-slate-100") flex-1 text-center py-2 px-4 rounded-md text-sm font-medium transition">
            Đã kích hoạt
        </button>
    </div>

    <!-- Users Table -->
    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">STT</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Tên đầy đủ</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Tên đăng nhập</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Vai trò</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Email</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Trạng thái</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Thao tác</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    @foreach (var user in Model)
                    {
                        <tr class="hover:bg-slate-50 transition">
                            <td class="px-4 py-3 text-sm text-slate-700">@(i++)</td>
                            <td class="px-4 py-3 text-sm font-medium text-slate-900">@(user.FullName ?? "N/A")</td>
                            <td class="px-4 py-3 text-sm text-slate-700">@user.Username</td>
                            <td class="px-4 py-3">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium @(user.Role?.ToLower() == "admin" ? "bg-purple-100 text-purple-800" : "bg-blue-100 text-blue-800")">
                                    @user.Role
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-slate-600">
                                @if (!string.IsNullOrWhiteSpace(user.Email))
                                {
                                    <span class="text-slate-700">@user.Email</span>
                                }
                                else
                                {
                                    <span class="text-xs text-slate-400">Chưa có</span>
                                }
                            </td>
                            <td class="px-4 py-3">
                                @if (user.IsActive)
                                {
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="bi bi-check-circle me-1"></i> Đã kích hoạt
                                    </span>
                                }
                                else
                                {
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="bi bi-clock me-1"></i> Chờ duyệt
                                    </span>
                                }
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    @if (!user.IsActive)
                                    {
                                        <form asp-action="Approve" method="post" class="m-0 user-action-form" style="display: inline;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@user.Id" />
                                            <input type="hidden" name="status" value="@status" />
                                            <button type="submit" class="text-xs px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded transition" title="Duyệt">
                                                <i class="bi bi-check"></i>
                                            </button>
                                        </form>
                                        <form asp-action="Reject" method="post" class="m-0 user-action-form" style="display: inline;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@user.Id" />
                                            <input type="hidden" name="status" value="@status" />
                                            <button type="submit" class="text-xs px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded transition" title="Từ chối">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </form>
                                    }
                                    <button type="button" data-bs-toggle="modal" data-bs-target="#editUserModal-@user.Id" class="text-xs px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded transition" title="Sửa">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <form asp-action="ResetPassword" method="post" class="m-0 user-action-form" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@user.Id" />
                                        <input type="hidden" name="newPassword" value="123456" />
                                        <input type="hidden" name="status" value="@status" />
                                        <button type="submit" class="text-xs px-2 py-1 bg-slate-600 hover:bg-slate-700 text-white rounded transition" title="Reset mật khẩu" onclick="return confirm('Đặt lại mật khẩu về 123456?');">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </form>
                                    <form asp-action="Delete" method="post" class="m-0 user-action-form" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@user.Id" />
                                        <input type="hidden" name="status" value="@status" />
                                        <button type="submit" class="text-xs px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded transition" title="Xóa" onclick="return confirm('Bạn có chắc muốn xóa người dùng này?');">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modals -->
@await Html.PartialAsync("_CreateModal", new MNBEMART.ViewModels.UserFormVM())

@foreach (var u in Model)
{
    @await Html.PartialAsync("_EditModal", u)
}

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Từ chối tài khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="rejectForm" method="post" asp-action="Reject" class="user-action-form">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="rejectUserId" />
                <input type="hidden" name="status" value="@status" />
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn từ chối tài khoản <strong id="rejectUsername"></strong>?</p>
                    <div class="mt-3">
                        <label for="rejectReason" class="form-label">Lý do từ chối (tùy chọn):</label>
                        <textarea name="reason" id="rejectReason" class="form-control" rows="3" 
                                  placeholder="Nhập lý do từ chối..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger">Xác nhận từ chối</button>
                </div>
            </form>
        </div>
    </div>
</div>

