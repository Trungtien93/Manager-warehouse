public class StockBalanceRebuilder
{
    private readonly AppDbContext _db;
    public StockBalanceRebuilder(AppDbContext db) => _db = db;

    public async Task RebuildAsync(DateOnly from, DateOnly to)
    {
        var fromDt = from.ToDateTime(TimeOnly.MinValue);
        var toDt   = to.ToDateTime(TimeOnly.MaxValue);

        // Xoá bucket cũ trong khoảng này (tuỳ chọn)
        var toDelete = await _db.StockBalances
            .Where(x => x.Date >= from && x.Date <= to).ToListAsync();
        _db.StockBalances.RemoveRange(toDelete);
        await _db.SaveChangesAsync();

        // ===== Receipts (In)
        var rec = await _db.StockReceiptDetails
            .Where(d => d.StockReceipt.Status == DocumentStatus.DaNhapHang
                     && d.StockReceipt.CreatedAt >= fromDt && d.StockReceipt.CreatedAt <= toDt)
            .Select(d => new {
                d.MaterialId,
                WhId = d.StockReceipt.WarehouseId,
                Dt   = DateOnly.FromDateTime((d.StockReceipt.ApprovedAt ?? d.StockReceipt.CreatedAt).Date),
                InQty  = (decimal)d.Quantity,
                InVal  = decimal.Round(d.UnitPrice * (decimal)d.Quantity, 2)
            }).ToListAsync();

        // ===== Issues (Out) – sửa Status theo dự án bạn (ví dụ: DaXuatHang)
        var iss = await _db.StockIssueDetails
            .Where(d => d.StockIssue.Status == DocumentStatus.DaNhapHang /* đổi cho đúng trạng thái 'Đã xuất' bên bạn */
                     && d.StockIssue.CreatedAt >= fromDt && d.StockIssue.CreatedAt <= toDt)
            .Select(d => new {
                d.MaterialId,
                WhId = d.StockIssue.WarehouseId,
                Dt   = DateOnly.FromDateTime((d.StockIssue.ApprovedAt ?? d.StockIssue.CreatedAt).Date),
                OutQty = (decimal)d.Quantity,
                OutVal = decimal.Round(d.UnitPrice * (decimal)d.Quantity, 2)
            }).ToListAsync();

        // ===== Transfers (Out từ kho đi, In vào kho đến) – sửa trạng thái theo bạn
        var tf = await _db.StockTransferDetails
            .Where(d => d.StockTransfer.CreatedAt >= fromDt && d.StockTransfer.CreatedAt <= toDt
                     /* && d.StockTransfer.Status == DocumentStatus.DaXacNhan */)
            .Select(d => new {
                d.MaterialId,
                Dt = DateOnly.FromDateTime((d.StockTransfer.ApprovedAt ?? d.StockTransfer.CreatedAt).Date),
                FromWh = d.StockTransfer.FromWarehouseId,
                ToWh   = d.StockTransfer.ToWarehouseId,
                Qty = (decimal)d.Quantity
            }).ToListAsync();

        // Gom bucket
        var buckets = new Dictionary<(int wh,int m,DateOnly dt),(decimal inQ,decimal outQ,decimal inV,decimal outV)>();

        void add(int wh,int m,DateOnly dt, decimal inQ=0, decimal outQ=0, decimal inV=0, decimal outV=0)
        {
            var key = (wh,m,dt);
            if (!buckets.TryGetValue(key, out var v)) v = (0,0,0,0);
            v.inQ  += inQ;  v.outQ += outQ;
            v.inV  += inV;  v.outV += outV;
            buckets[key] = v;
        }

        foreach (var x in rec) add(x.WhId, x.MaterialId, x.Dt, inQ:x.InQty, inV:x.InVal);
        foreach (var x in iss) add(x.WhId, x.MaterialId, x.Dt, outQ:x.OutQty, outV:x.OutVal);
        foreach (var x in tf)
        {
            add(x.FromWh, x.MaterialId, x.Dt, outQ:x.Qty);
            add(x.ToWh,   x.MaterialId, x.Dt, inQ :x.Qty);
        }

        // Lưu
        foreach (var kv in buckets)
        {
            var (wh, m, dt) = kv.Key;
            var v = kv.Value;
            _db.StockBalances.Add(new StockBalance {
                WarehouseId = wh,
                MaterialId  = m,
                Date        = dt,
                InQty = v.inQ, OutQty = v.outQ,
                InValue = v.inV, OutValue = v.outV,
                UpdatedAt = DateTime.UtcNow
            });
        }
        await _db.SaveChangesAsync();
    }
}
